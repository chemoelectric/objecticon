<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>popupeditor.icn</title></head><body><pre>
<a name="1"/>package gui
<a name="2"/>
<a name="3"/>import graphics
<a name="4"/>
<a name="5"/>#
<a name="6"/># A class for wrapping a transient popup editor.
<a name="7"/>#
<a name="8"/>class PopupEditor(Component, MenuMode)
<a name="9"/>   private old_focus, editor, comp
<a name="10"/>
<a name="11"/>   public popup(comp, ev)
<a name="12"/>      self.comp := comp
<a name="13"/>      # Copy attribs of the parent component
<a name="14"/>      set_wattrib_ancestor(comp)
<a name="15"/>      set_z(comp.parent_dialog.get_top_z())
<a name="16"/>      comp.parent_dialog.add(self)
<a name="17"/>      unless parent_dialog.enter_menu_mode(self) then {
<a name="18"/>         parent.remove(self)
<a name="19"/>         self.comp := &amp;null
<a name="20"/>         fail
<a name="21"/>      }
<a name="22"/>      resize()
<a name="23"/>      old_focus := parent_dialog.get_focus()
<a name="24"/>      editor.grab_focus()
<a name="25"/>      invalidate()
<a name="26"/>      fire(Event.POPUP_OPENED)
<a name="27"/>      link
<a name="28"/>   end
<a name="29"/>
<a name="30"/>   public override layout()
<a name="31"/>      editor.x := self.x
<a name="32"/>      editor.y := self.y
<a name="33"/>      editor.w := self.w
<a name="34"/>      editor.h := self.h
<a name="35"/>      editor.layout()
<a name="36"/>   end
<a name="37"/>
<a name="38"/>   public override should_close(e)
<a name="39"/>      succeed member(Mouse.PRESS, e.code) &amp; not(editor.in_region(e))
<a name="40"/>   end
<a name="41"/>
<a name="42"/>   public override allow_nested(c)
<a name="43"/>      c := c.get_nesting_component()
<a name="44"/>      succeed c.gen_parents() === editor
<a name="45"/>   end
<a name="46"/>
<a name="47"/>   public override get_nesting_component()
<a name="48"/>      return comp
<a name="49"/>   end
<a name="50"/>
<a name="51"/>   public override gen_popup_components()
<a name="52"/>      return editor
<a name="53"/>   end
<a name="54"/>
<a name="55"/>   protected forward_key(ev, src, type)
<a name="56"/>      # In menu mode key events are forwarded to this component,
<a name="57"/>      # rather than the editor, regardless of the focus.  So we
<a name="58"/>      # must forward them ourselves.
<a name="59"/>      if /ev.release &amp; ev.code === "\e" then
<a name="60"/>         close_all()
<a name="61"/>      else
<a name="62"/>         parent_dialog.get_focus().fire(type, ev)
<a name="63"/>   end
<a name="64"/>
<a name="65"/>   public override close_all()
<a name="66"/>      parent_dialog.set_focus(old_focus)
<a name="67"/>      invalidate()
<a name="68"/>      parent_dialog.exit_menu_mode(self)
<a name="69"/>      parent.remove(self)
<a name="70"/>      self.comp := &amp;null
<a name="71"/>      fire(Event.POPUP_CLOSED)
<a name="72"/>   end
<a name="73"/>
<a name="74"/>   public override new(editor)
<a name="75"/>      Component.new()
<a name="76"/>      self.editor := editor
<a name="77"/>      editor.connect(close_all, Event.ACTION)
<a name="78"/>      self.add(editor)
<a name="79"/>      every connect(self.forward_key, Event.KEY_PRESS | Event.KEY_RELEASE)
<a name="80"/>      return
<a name="81"/>   end
<a name="82"/>end
</pre></body></html>
