<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>childwait.icn</title></head><body><pre>
<a name="1"/>package ipl.childwait
<a name="2"/>
<a name="3"/>import gui, posix
<a name="4"/>
<a name="5"/>record Waiting(pid, on_exit)
<a name="6"/>
<a name="7"/># This class is used to cleanup child processes when they exit, using
<a name="8"/># the System.wait call.
<a name="9"/>#
<a name="10"/>final abstract class ChildWait()
<a name="11"/>   private static
<a name="12"/>      waiting,
<a name="13"/>      task
<a name="14"/>
<a name="15"/>   private static init()
<a name="16"/>      waiting := set()
<a name="17"/>      task := Dispatcher.new_task{child_cleanup()}
<a name="18"/>      task.start()
<a name="19"/>   end
<a name="20"/>
<a name="21"/>   # Add a pid to wait for.  The optional `on_exit` function is called
<a name="22"/>   # after the given pid exits.
<a name="23"/>   #
<a name="24"/>   public static add_pid(pid, on_exit)
<a name="25"/>      insert(waiting, Waiting(pid, on_exit))
<a name="26"/>      link
<a name="27"/>   end
<a name="28"/>
<a name="29"/>   private static child_cleanup()
<a name="30"/>      local r, w
<a name="31"/>      repeat {
<a name="32"/>         task.sleep(1000)
<a name="33"/>         every w := !waiting do {
<a name="34"/>            if r := System.wait(w.pid, WaitOpt.WNOHANG) &amp; r.pid &gt; 0 then {
<a name="35"/>               (\w.on_exit)(r)
<a name="36"/>               delete(waiting, w)
<a name="37"/>            }
<a name="38"/>         }
<a name="39"/>      }
<a name="40"/>   end
<a name="41"/>end
</pre></body></html>
