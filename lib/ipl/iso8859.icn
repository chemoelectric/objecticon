package ipl.charset

import lang(Text), util(need_integer, need_string, need_ucs)

class ISO8859()
   private static const
      TO_UCS, FROM_UCS

   private static init()
      TO_UCS := table()
      FROM_UCS := table()
      insert(TO_UCS, 1, [160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255])
      insert(FROM_UCS, 1, table(,160,160,161,161,162,162,163,163,164,164,165,165,166,166,167,167,168,168,169,169,170,170,171,171,172,172,173,173,174,174,175,175,176,176,177,177,178,178,179,179,180,180,181,181,182,182,183,183,184,184,185,185,186,186,187,187,188,188,189,189,190,190,191,191,192,192,193,193,194,194,195,195,196,196,197,197,198,198,199,199,200,200,201,201,202,202,203,203,204,204,205,205,206,206,207,207,208,208,209,209,210,210,211,211,212,212,213,213,214,214,215,215,216,216,217,217,218,218,219,219,220,220,221,221,222,222,223,223,224,224,225,225,226,226,227,227,228,228,229,229,230,230,231,231,232,232,233,233,234,234,235,235,236,236,237,237,238,238,239,239,240,240,241,241,242,242,243,243,244,244,245,245,246,246,247,247,248,248,249,249,250,250,251,251,252,252,253,253,254,254,255,255))
      insert(TO_UCS, 2, [160,260,728,321,164,317,346,167,168,352,350,356,377,173,381,379,176,261,731,322,180,318,347,711,184,353,351,357,378,733,382,380,340,193,194,258,196,313,262,199,268,201,280,203,282,205,206,270,272,323,327,211,212,336,214,215,344,366,218,368,220,221,354,223,341,225,226,259,228,314,263,231,269,233,281,235,283,237,238,271,273,324,328,243,244,337,246,247,345,367,250,369,252,253,355,729])
      insert(FROM_UCS, 2, table(,160,160,164,164,167,167,168,168,173,173,176,176,180,180,184,184,193,193,194,194,196,196,199,199,201,201,203,203,205,205,206,206,211,211,212,212,214,214,215,215,218,218,220,220,221,221,223,223,225,225,226,226,228,228,231,231,233,233,235,235,237,237,238,238,243,243,244,244,246,246,247,247,250,250,252,252,253,253,258,195,259,227,260,161,261,177,262,198,263,230,268,200,269,232,270,207,271,239,272,208,273,240,280,202,281,234,282,204,283,236,313,197,314,229,317,165,318,181,321,163,322,179,323,209,324,241,327,210,328,242,336,213,337,245,340,192,341,224,344,216,345,248,346,166,347,182,350,170,351,186,352,169,353,185,354,222,355,254,356,171,357,187,366,217,367,249,368,219,369,251,377,172,378,188,379,175,380,191,381,174,382,190,711,183,728,162,729,255,731,178,733,189))
      insert(TO_UCS, 3, [160,294,728,163,164,63,292,167,168,304,350,286,308,173,63,379,176,295,178,179,180,181,293,183,184,305,351,287,309,189,63,380,192,193,194,63,196,266,264,199,200,201,202,203,204,205,206,207,63,209,210,211,212,288,214,215,284,217,218,219,220,364,348,223,224,225,226,63,228,267,265,231,232,233,234,235,236,237,238,239,63,241,242,243,244,289,246,247,285,249,250,251,252,365,349,729])
      insert(FROM_UCS, 3, table(,160,160,163,163,164,164,167,167,168,168,173,173,176,176,178,178,179,179,180,180,181,181,183,183,184,184,189,189,192,192,193,193,194,194,196,196,199,199,200,200,201,201,202,202,203,203,204,204,205,205,206,206,207,207,209,209,210,210,211,211,212,212,214,214,215,215,217,217,218,218,219,219,220,220,223,223,224,224,225,225,226,226,228,228,231,231,232,232,233,233,234,234,235,235,236,236,237,237,238,238,239,239,241,241,242,242,243,243,244,244,246,246,247,247,249,249,250,250,251,251,252,252,264,198,265,230,266,197,267,229,284,216,285,248,286,171,287,187,288,213,289,245,292,166,293,182,294,161,295,177,304,169,305,185,308,172,309,188,348,222,349,254,350,170,351,186,364,221,365,253,379,175,380,191,728,162,729,255))
      insert(TO_UCS, 4, [160,260,312,342,164,296,315,167,168,352,274,290,358,173,381,175,176,261,731,343,180,297,316,711,184,353,275,291,359,330,382,331,256,193,194,195,196,197,198,302,268,201,280,203,278,205,206,298,272,325,332,310,212,213,214,215,216,370,218,219,220,360,362,223,257,225,226,227,228,229,230,303,269,233,281,235,279,237,238,299,273,326,333,311,244,245,246,247,248,371,250,251,252,361,363,729])
      insert(FROM_UCS, 4, table(,160,160,164,164,167,167,168,168,173,173,175,175,176,176,180,180,184,184,193,193,194,194,195,195,196,196,197,197,198,198,201,201,203,203,205,205,206,206,212,212,213,213,214,214,215,215,216,216,218,218,219,219,220,220,223,223,225,225,226,226,227,227,228,228,229,229,230,230,233,233,235,235,237,237,238,238,244,244,245,245,246,246,247,247,248,248,250,250,251,251,252,252,256,192,257,224,260,161,261,177,268,200,269,232,272,208,273,240,274,170,275,186,278,204,279,236,280,202,281,234,290,171,291,187,296,165,297,181,298,207,299,239,302,199,303,231,310,211,311,243,312,162,315,166,316,182,325,209,326,241,330,189,331,191,332,210,333,242,342,163,343,179,352,169,353,185,358,172,359,188,360,221,361,253,362,222,363,254,370,217,371,249,381,174,382,190,711,183,729,255,731,178))
      insert(TO_UCS, 5, [160,1025,1026,1027,1028,1029,1030,1031,1032,1033,1034,1035,1036,173,1038,1039,1040,1041,1042,1043,1044,1045,1046,1047,1048,1049,1050,1051,1052,1053,1054,1055,1056,1057,1058,1059,1060,1061,1062,1063,1064,1065,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1076,1077,1078,1079,1080,1081,1082,1083,1084,1085,1086,1087,1088,1089,1090,1091,1092,1093,1094,1095,1096,1097,1098,1099,1100,1101,1102,1103,8470,1105,1106,1107,1108,1109,1110,1111,1112,1113,1114,1115,1116,167,1118,1119])
      insert(FROM_UCS, 5, table(,160,160,167,253,173,173,1025,161,1026,162,1027,163,1028,164,1029,165,1030,166,1031,167,1032,168,1033,169,1034,170,1035,171,1036,172,1038,174,1039,175,1040,176,1041,177,1042,178,1043,179,1044,180,1045,181,1046,182,1047,183,1048,184,1049,185,1050,186,1051,187,1052,188,1053,189,1054,190,1055,191,1056,192,1057,193,1058,194,1059,195,1060,196,1061,197,1062,198,1063,199,1064,200,1065,201,1066,202,1067,203,1068,204,1069,205,1070,206,1071,207,1072,208,1073,209,1074,210,1075,211,1076,212,1077,213,1078,214,1079,215,1080,216,1081,217,1082,218,1083,219,1084,220,1085,221,1086,222,1087,223,1088,224,1089,225,1090,226,1091,227,1092,228,1093,229,1094,230,1095,231,1096,232,1097,233,1098,234,1099,235,1100,236,1101,237,1102,238,1103,239,1105,241,1106,242,1107,243,1108,244,1109,245,1110,246,1111,247,1112,248,1113,249,1114,250,1115,251,1116,252,1118,254,1119,255,8470,240))
      insert(TO_UCS, 6, [160,63,63,63,164,63,63,63,63,63,63,63,1548,173,63,63,63,63,63,63,63,63,63,63,63,63,63,1563,63,63,63,1567,63,1569,1570,1571,1572,1573,1574,1575,1576,1577,1578,1579,1580,1581,1582,1583,1584,1585,1586,1587,1588,1589,1590,1591,1592,1593,1594,63,63,63,63,63,1600,1601,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,63,63,63,63,63,63,63,63,63,63,63,63,63])
      insert(FROM_UCS, 6, table(,160,160,164,164,173,173,1548,172,1563,187,1567,191,1569,193,1570,194,1571,195,1572,196,1573,197,1574,198,1575,199,1576,200,1577,201,1578,202,1579,203,1580,204,1581,205,1582,206,1583,207,1584,208,1585,209,1586,210,1587,211,1588,212,1589,213,1590,214,1591,215,1592,216,1593,217,1594,218,1600,224,1601,225,1602,226,1603,227,1604,228,1605,229,1606,230,1607,231,1608,232,1609,233,1610,234,1611,235,1612,236,1613,237,1614,238,1615,239,1616,240,1617,241,1618,242))
      insert(TO_UCS, 7, [160,8216,8217,163,8364,8367,166,167,168,169,890,171,172,173,63,8213,176,177,178,179,900,901,902,183,904,905,906,187,908,189,910,911,912,913,914,915,916,917,918,919,920,921,922,923,924,925,926,927,928,929,63,931,932,933,934,935,936,937,938,939,940,941,942,943,944,945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969,970,971,972,973,974,63])
      insert(FROM_UCS, 7, table(,160,160,163,163,166,166,167,167,168,168,169,169,171,171,172,172,173,173,176,176,177,177,178,178,179,179,183,183,187,187,189,189,890,170,900,180,901,181,902,182,904,184,905,185,906,186,908,188,910,190,911,191,912,192,913,193,914,194,915,195,916,196,917,197,918,198,919,199,920,200,921,201,922,202,923,203,924,204,925,205,926,206,927,207,928,208,929,209,931,211,932,212,933,213,934,214,935,215,936,216,937,217,938,218,939,219,940,220,941,221,942,222,943,223,944,224,945,225,946,226,947,227,948,228,949,229,950,230,951,231,952,232,953,233,954,234,955,235,956,236,957,237,958,238,959,239,960,240,961,241,962,242,963,243,964,244,965,245,966,246,967,247,968,248,969,249,970,250,971,251,972,252,973,253,974,254,8213,175,8216,161,8217,162,8364,164,8367,165))
      insert(TO_UCS, 8, [160,63,162,163,164,165,166,167,168,169,215,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,247,187,188,189,190,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,8215,1488,1489,1490,1491,1492,1493,1494,1495,1496,1497,1498,1499,1500,1501,1502,1503,1504,1505,1506,1507,1508,1509,1510,1511,1512,1513,1514,63,63,8206,8207,63])
      insert(FROM_UCS, 8, table(,160,160,162,162,163,163,164,164,165,165,166,166,167,167,168,168,169,169,171,171,172,172,173,173,174,174,175,175,176,176,177,177,178,178,179,179,180,180,181,181,182,182,183,183,184,184,185,185,187,187,188,188,189,189,190,190,215,170,247,186,1488,224,1489,225,1490,226,1491,227,1492,228,1493,229,1494,230,1495,231,1496,232,1497,233,1498,234,1499,235,1500,236,1501,237,1502,238,1503,239,1504,240,1505,241,1506,242,1507,243,1508,244,1509,245,1510,246,1511,247,1512,248,1513,249,1514,250,8206,253,8207,254,8215,223))
      insert(TO_UCS, 9, [160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,286,209,210,211,212,213,214,215,216,217,218,219,220,304,350,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,287,241,242,243,244,245,246,247,248,249,250,251,252,305,351,255])
      insert(FROM_UCS, 9, table(,160,160,161,161,162,162,163,163,164,164,165,165,166,166,167,167,168,168,169,169,170,170,171,171,172,172,173,173,174,174,175,175,176,176,177,177,178,178,179,179,180,180,181,181,182,182,183,183,184,184,185,185,186,186,187,187,188,188,189,189,190,190,191,191,192,192,193,193,194,194,195,195,196,196,197,197,198,198,199,199,200,200,201,201,202,202,203,203,204,204,205,205,206,206,207,207,209,209,210,210,211,211,212,212,213,213,214,214,215,215,216,216,217,217,218,218,219,219,220,220,223,223,224,224,225,225,226,226,227,227,228,228,229,229,230,230,231,231,232,232,233,233,234,234,235,235,236,236,237,237,238,238,239,239,241,241,242,242,243,243,244,244,245,245,246,246,247,247,248,248,249,249,250,250,251,251,252,252,255,255,286,208,287,240,304,221,305,253,350,222,351,254))
      insert(TO_UCS, 10, [160,260,274,290,298,296,310,167,315,272,352,358,381,173,362,330,176,261,275,291,299,297,311,183,316,273,353,359,382,8213,363,331,256,193,194,195,196,197,198,302,268,201,280,203,278,205,206,207,208,325,332,211,212,213,214,360,216,370,218,219,220,221,222,223,257,225,226,227,228,229,230,303,269,233,281,235,279,237,238,239,240,326,333,243,244,245,246,361,248,371,250,251,252,253,254,312])
      insert(FROM_UCS, 10, table(,160,160,167,167,173,173,176,176,183,183,193,193,194,194,195,195,196,196,197,197,198,198,201,201,203,203,205,205,206,206,207,207,208,208,211,211,212,212,213,213,214,214,216,216,218,218,219,219,220,220,221,221,222,222,223,223,225,225,226,226,227,227,228,228,229,229,230,230,233,233,235,235,237,237,238,238,239,239,240,240,243,243,244,244,245,245,246,246,248,248,250,250,251,251,252,252,253,253,254,254,256,192,257,224,260,161,261,177,268,200,269,232,272,169,273,185,274,162,275,178,278,204,279,236,280,202,281,234,290,163,291,179,296,165,297,181,298,164,299,180,302,199,303,231,310,166,311,182,312,255,315,168,316,184,325,209,326,241,330,175,331,191,332,210,333,242,352,170,353,186,358,171,359,187,360,215,361,247,362,174,363,190,370,217,371,249,381,172,382,188,8213,189))
      insert(TO_UCS, 11, [160,3585,3586,3587,3588,3589,3590,3591,3592,3593,3594,3595,3596,3597,3598,3599,3600,3601,3602,3603,3604,3605,3606,3607,3608,3609,3610,3611,3612,3613,3614,3615,3616,3617,3618,3619,3620,3621,3622,3623,3624,3625,3626,3627,3628,3629,3630,3631,3632,3633,3634,3635,3636,3637,3638,3639,3640,3641,3642,63,63,63,63,3647,3648,3649,3650,3651,3652,3653,3654,3655,3656,3657,3658,3659,3660,3661,3662,3663,3664,3665,3666,3667,3668,3669,3670,3671,3672,3673,3674,3675,63,63,63,63])
      insert(FROM_UCS, 11, table(,160,160,3585,161,3586,162,3587,163,3588,164,3589,165,3590,166,3591,167,3592,168,3593,169,3594,170,3595,171,3596,172,3597,173,3598,174,3599,175,3600,176,3601,177,3602,178,3603,179,3604,180,3605,181,3606,182,3607,183,3608,184,3609,185,3610,186,3611,187,3612,188,3613,189,3614,190,3615,191,3616,192,3617,193,3618,194,3619,195,3620,196,3621,197,3622,198,3623,199,3624,200,3625,201,3626,202,3627,203,3628,204,3629,205,3630,206,3631,207,3632,208,3633,209,3634,210,3635,211,3636,212,3637,213,3638,214,3639,215,3640,216,3641,217,3642,218,3647,223,3648,224,3649,225,3650,226,3651,227,3652,228,3653,229,3654,230,3655,231,3656,232,3657,233,3658,234,3659,235,3660,236,3661,237,3662,238,3663,239,3664,240,3665,241,3666,242,3667,243,3668,244,3669,245,3670,246,3671,247,3672,248,3673,249,3674,250,3675,251))
      insert(TO_UCS, 13, [160,8221,162,163,164,8222,166,167,216,169,342,171,172,173,174,198,176,177,178,179,8220,181,182,183,248,185,343,187,188,189,190,230,260,302,256,262,196,197,280,274,268,201,377,278,290,310,298,315,352,323,325,211,332,213,214,215,370,321,346,362,220,379,381,223,261,303,257,263,228,229,281,275,269,233,378,279,291,311,299,316,353,324,326,243,333,245,246,247,371,322,347,363,252,380,382,8217])
      insert(FROM_UCS, 13, table(,160,160,162,162,163,163,164,164,166,166,167,167,169,169,171,171,172,172,173,173,174,174,176,176,177,177,178,178,179,179,181,181,182,182,183,183,185,185,187,187,188,188,189,189,190,190,196,196,197,197,198,175,201,201,211,211,213,213,214,214,215,215,216,168,220,220,223,223,228,228,229,229,230,191,233,233,243,243,245,245,246,246,247,247,248,184,252,252,256,194,257,226,260,192,261,224,262,195,263,227,268,200,269,232,274,199,275,231,278,203,279,235,280,198,281,230,290,204,291,236,298,206,299,238,302,193,303,225,310,205,311,237,315,207,316,239,321,217,322,249,323,209,324,241,325,210,326,242,332,212,333,244,342,170,343,186,346,218,347,250,352,208,353,240,362,219,363,251,370,216,371,248,377,202,378,234,379,221,380,253,381,222,382,254,8217,255,8220,180,8221,161,8222,165))
      insert(TO_UCS, 14, [160,7682,7683,163,266,267,7690,167,7808,169,7810,7691,7922,173,174,376,7710,7711,288,289,7744,7745,182,7766,7809,7767,7811,7776,7923,7812,7813,7777,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,372,209,210,211,212,213,214,7786,216,217,218,219,220,221,374,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,373,241,242,243,244,245,246,7787,248,249,250,251,252,253,375,255])
      insert(FROM_UCS, 14, table(,160,160,163,163,167,167,169,169,173,173,174,174,182,182,192,192,193,193,194,194,195,195,196,196,197,197,198,198,199,199,200,200,201,201,202,202,203,203,204,204,205,205,206,206,207,207,209,209,210,210,211,211,212,212,213,213,214,214,216,216,217,217,218,218,219,219,220,220,221,221,223,223,224,224,225,225,226,226,227,227,228,228,229,229,230,230,231,231,232,232,233,233,234,234,235,235,236,236,237,237,238,238,239,239,241,241,242,242,243,243,244,244,245,245,246,246,248,248,249,249,250,250,251,251,252,252,253,253,255,255,266,164,267,165,288,178,289,179,372,208,373,240,374,222,375,254,376,175,7682,161,7683,162,7690,166,7691,171,7710,176,7711,177,7744,180,7745,181,7766,183,7767,185,7776,187,7777,191,7786,215,7787,247,7808,168,7809,184,7810,170,7811,186,7812,189,7813,190,7922,172,7923,188))
      insert(TO_UCS, 15, [160,161,162,163,8364,165,352,167,353,169,170,171,172,173,174,175,176,177,178,179,381,181,182,183,382,185,186,187,338,339,376,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255])
      insert(FROM_UCS, 15, table(,160,160,161,161,162,162,163,163,165,165,167,167,169,169,170,170,171,171,172,172,173,173,174,174,175,175,176,176,177,177,178,178,179,179,181,181,182,182,183,183,185,185,186,186,187,187,191,191,192,192,193,193,194,194,195,195,196,196,197,197,198,198,199,199,200,200,201,201,202,202,203,203,204,204,205,205,206,206,207,207,208,208,209,209,210,210,211,211,212,212,213,213,214,214,215,215,216,216,217,217,218,218,219,219,220,220,221,221,222,222,223,223,224,224,225,225,226,226,227,227,228,228,229,229,230,230,231,231,232,232,233,233,234,234,235,235,236,236,237,237,238,238,239,239,240,240,241,241,242,242,243,243,244,244,245,245,246,246,247,247,248,248,249,249,250,250,251,251,252,252,253,253,254,254,255,255,338,188,339,189,352,166,353,168,376,190,381,180,382,184,8364,164))
      insert(TO_UCS, 16, [160,260,261,321,8364,8222,352,167,353,169,536,171,377,173,378,379,176,177,268,322,381,8221,182,183,382,269,537,187,338,339,376,380,192,193,194,258,196,262,198,199,200,201,202,203,204,205,206,207,272,323,210,211,212,336,214,346,368,217,218,219,220,280,538,223,224,225,226,259,228,263,230,231,232,233,234,235,236,237,238,239,273,324,242,243,244,337,246,347,369,249,250,251,252,281,539,255])
      insert(FROM_UCS, 16, table(,160,160,167,167,169,169,171,171,173,173,176,176,177,177,182,182,183,183,187,187,192,192,193,193,194,194,196,196,198,198,199,199,200,200,201,201,202,202,203,203,204,204,205,205,206,206,207,207,210,210,211,211,212,212,214,214,217,217,218,218,219,219,220,220,223,223,224,224,225,225,226,226,228,228,230,230,231,231,232,232,233,233,234,234,235,235,236,236,237,237,238,238,239,239,242,242,243,243,244,244,246,246,249,249,250,250,251,251,252,252,255,255,258,195,259,227,260,161,261,162,262,197,263,229,268,178,269,185,272,208,273,240,280,221,281,253,321,163,322,179,323,209,324,241,336,213,337,245,338,188,339,189,346,215,347,247,352,166,353,168,368,216,369,248,376,190,377,172,378,174,379,175,380,191,381,180,382,184,536,170,537,186,538,222,539,254,8221,181,8222,165,8364,164))
   end

   #
   # Convert an ISO-8859-n string to ucs
   #
   public static to_ucs(s, n)
      local t, ch, l
      s := need_string(s)
      n := need_integer(n)
      l := member(TO_UCS, n) | fail
      t := ""
      s ? repeat {
         t ||:= tab(many(&ascii))
         ch := ord(move(1)) | break
         if ch >= 160 then
            ch := l[ch - 160 + 1]
         t ||:= Text.utf8_seq(ch)
      }
      return ucs(t)
   end

   #
   # Convert a ucs to ISO-8859-n string; characters out of range are
   # represented by the subst string (default "?").
   #
   public static from_ucs(s, n, subst)
      local t, ch, m
      s := need_ucs(s)
      n := need_integer(n)
      m := member(FROM_UCS, n) | fail
      /subst := "?"
      t := ""
      s ? repeat {
         t ||:= string(tab(many(&ascii)))
         ch := ord(move(1)) | break
         if ch >= 160 then
            ch := member(m, ch) | subst
         t ||:= char(ch)
      }
      return t
   end
end
