<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>vrml.icn</title></head><body><pre>
<a name="1"/>############################################################################
<a name="2"/>#
<a name="3"/>#	File:     vrml.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures to support creation of VRML files
<a name="6"/>#
<a name="7"/>#	Author:   Ralph E. Griswold
<a name="8"/>#
<a name="9"/>#	Date:     May 2, 2001
<a name="10"/>#
<a name="11"/>############################################################################
<a name="12"/>#
<a name="13"/>#  This file is in the public domain.
<a name="14"/>#
<a name="15"/>############################################################################
<a name="16"/>#
<a name="17"/>#  This file contains procedures for producing VRML files.
<a name="18"/>#
<a name="19"/>#	point_field(L)	create VRML point field from point list L
<a name="20"/>#
<a name="21"/>#	u_crd_idx(i)	create VRML coordinate index for 0 through i - 1
<a name="22"/>#
<a name="23"/>#	render(x)	render node x
<a name="24"/>#
<a name="25"/>#	vrml1(x)	produces VRML 1.0 file for node x
<a name="26"/>#
<a name="27"/>#	vrml2(x)	produces VRML 2.0 file for node x
<a name="28"/>#
<a name="29"/>#	vrml_color(s)	convert Icon color specification to vrml form
<a name="30"/>#
<a name="31"/>#  Notes:
<a name="32"/>#
<a name="33"/>#    Not all node types have been tested.
<a name="34"/>#
<a name="35"/>#    Where field values are complex, as in vectors, these must be built
<a name="36"/>#    separately as strings to go in the appropriate fields.
<a name="37"/>#
<a name="38"/>#    There is no error checking.  Fields must be given in the
<a name="39"/>#    order they appear in the node record declarations and field values
<a name="40"/>#    must be of the correct type and form.
<a name="41"/>#
<a name="42"/>#  The introduction of record types other than for nodes will cause
<a name="43"/>#  bogus output.  A structural loop will produce output until the
<a name="44"/>#  evaluation stack overflows.
<a name="45"/>#
<a name="46"/>############################################################################
<a name="47"/>#
<a name="48"/>#  Links:  ptutils, records
<a name="49"/>#
<a name="50"/>############################################################################
<a name="51"/>#
<a name="52"/>#  Requires:  Version 9 graphics for color conversion
<a name="53"/>#
<a name="54"/>############################################################################
<a name="55"/>#
<a name="56"/>#  See also:  vrml1lib.icn and vrml2.icn
<a name="57"/>#
<a name="58"/>############################################################################
<a name="59"/>
<a name="60"/>package ipl.vrml
<a name="61"/>
<a name="62"/>import
<a name="63"/>   graphics(Window),
<a name="64"/>   io(close, open, read, stop,
<a name="65"/>      write, writes),
<a name="66"/>   ipl.ptutils(pt2coord),
<a name="67"/>   ipl.types(itype),
<a name="68"/>   lang(Constructor)
<a name="69"/>
<a name="70"/># create VRML point field
<a name="71"/>procedure point_field(pts)	
<a name="72"/>   local field
<a name="73"/>
<a name="74"/>   field := "[\n"
<a name="75"/>
<a name="76"/>   every field ||:= pt2coord(!pts) || ",\n"
<a name="77"/>
<a name="78"/>   return field || "\n]"
<a name="79"/>
<a name="80"/>end
<a name="81"/>
<a name="82"/># create VRML coordinate index
<a name="83"/>procedure u_crd_idx(i)		
<a name="84"/>   local index
<a name="85"/>
<a name="86"/>   index := "[\n"
<a name="87"/>
<a name="88"/>   every index ||:= (0 to i - 1) || ",\n"
<a name="89"/>
<a name="90"/>   return index ||:= "\n]"
<a name="91"/>
<a name="92"/>end
<a name="93"/>
<a name="94"/>
<a name="95"/>
<a name="96"/>
<a name="97"/>
<a name="98"/># write VRML 1.0 file
<a name="99"/>procedure vrml1(x, f) 		
<a name="100"/>
<a name="101"/>   write(f, "#VRML V1.0 ascii")
<a name="102"/>
<a name="103"/>   render(x, f)
<a name="104"/>
<a name="105"/>end
<a name="106"/>
<a name="107"/># produce VRML 2.0 file
<a name="108"/>procedure vrml2(x, f)		
<a name="109"/>
<a name="110"/>   write(f, "#VRML V2.0 utf8")
<a name="111"/>
<a name="112"/>   render(x, f)
<a name="113"/>
<a name="114"/>end
<a name="115"/>
<a name="116"/># render VRML object
<a name="117"/>procedure render(x, f)		
<a name="118"/>   local i, bar, fieldname, input
<a name="119"/>   static indent
<a name="120"/>
<a name="121"/>   initial indent := 0
<a name="122"/>
<a name="123"/>   if /x then return		# skip any stray null values
<a name="124"/>
<a name="125"/>   indent +:= 3
<a name="126"/>   bar := repl(" ", indent)
<a name="127"/>
<a name="128"/>   if x := string(x) then write(f, " ", x)
<a name="129"/>   else case itype(x) of {
<a name="130"/>      "USE": write(f, bar, "USE ", x.name)
<a name="131"/>      "DEF": {
<a name="132"/>         writes(f, bar, "DEF ", x.name)
<a name="133"/>         render(x.node, f)
<a name="134"/>         }
<a name="135"/>      "Comment": write(f, "# ", x.text)
<a name="136"/>      "Include":  {
<a name="137"/>         input := open(x.name) | stop("*** cannot find inline file")
<a name="138"/>         while write(f, read(input))
<a name="139"/>         close(input)
<a name="140"/>         }
<a name="141"/>      default: {				# all other nodes
<a name="142"/>         write(f, bar, itype(x), " {")		# must be record for VRML node
<a name="143"/>         every i := 1 to *x do {
<a name="144"/>           if type(x[i]) == "list" then		# list of children
<a name="145"/>               every render(!x[i], f)
<a name="146"/>            else if /x[i] then next		# skip empty fields
<a name="147"/>            else {
<a name="148"/>               writes(f, bar, "   ")
<a name="149"/>               fieldname := Constructor.get_field_name(x, i)
<a name="150"/>               if fieldname ~== "null" then writes(f, fieldname)
<a name="151"/>               render(x[i], f)
<a name="152"/>               }
<a name="153"/>            }
<a name="154"/>         write(f, bar, "   }")
<a name="155"/>         }
<a name="156"/>      }
<a name="157"/>
<a name="158"/>   indent -:= 3
<a name="159"/>
<a name="160"/>   return
<a name="161"/>
<a name="162"/>end
<a name="163"/>
<a name="164"/>procedure vrml_color(s)
<a name="165"/>   local result
<a name="166"/>   static factor
<a name="167"/>
<a name="168"/>   initial factor := real(2 ^ 16 - 1)
<a name="169"/>
<a name="170"/>   s := Window.color_value(s) | fail
<a name="171"/>
<a name="172"/>   result := ""
<a name="173"/>
<a name="174"/>   s ? {
<a name="175"/>      every 1 to 3 do {
<a name="176"/>         result ||:= (tab(upto(',') | 0) / factor) || " "
<a name="177"/>         move(1)
<a name="178"/>         }
<a name="179"/>      }
<a name="180"/>
<a name="181"/>   return result
<a name="182"/>
<a name="183"/>end
</pre></body></html>
