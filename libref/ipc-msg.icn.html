<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>msg.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: msg.icn 8644 2020-11-05 20:30:57Z rparlett $
<a name="3"/>#
<a name="4"/># This file is in the public domain.
<a name="5"/>#
<a name="6"/># Author: Robert Parlett (parlett@dial.pipex.com)
<a name="7"/>#
<a name="8"/>
<a name="9"/>package ipc
<a name="10"/>
<a name="11"/>import lang, util
<a name="12"/>
<a name="13"/>#
<a name="14"/># This class provides an inter process messaging facility.  The
<a name="15"/># implementation requires the accompanying native library to be on the
<a name="16"/># library path.
<a name="17"/>#
<a name="18"/># Instances of this class should not be created directly, but rather
<a name="19"/># using the static methods `open_public`, `create_public` and
<a name="20"/># `create_private`
<a name="21"/>#
<a name="22"/>final class Msg(NoCopy, HasClose)
<a name="23"/>   private 
<a name="24"/>      id
<a name="25"/>
<a name="26"/>   #
<a name="27"/>   # Send the given object.  The object may be an arbitrary Icon
<a name="28"/>   # structure, and will be encoded into a string by the `encode()`
<a name="29"/>   # procedure.
<a name="30"/>   #
<a name="31"/>   public send(o)
<a name="32"/>      return send_impl(encode(o, &amp;yes))
<a name="33"/>   end
<a name="34"/>
<a name="35"/>   private native send_impl(s)
<a name="36"/>
<a name="37"/>   #
<a name="38"/>   # Receive an object from the queue, waiting if necessary.
<a name="39"/>   #
<a name="40"/>   public receive()
<a name="41"/>      return decode(receive_impl())
<a name="42"/>   end
<a name="43"/>
<a name="44"/>   private native receive_impl()
<a name="45"/>
<a name="46"/>   #
<a name="47"/>   # Attempt to get an object from the queue, failing if one is not
<a name="48"/>   # ready immediately.
<a name="49"/>   #
<a name="50"/>   public attempt()
<a name="51"/>      return decode(attempt_impl())
<a name="52"/>   end
<a name="53"/>
<a name="54"/>   private native attempt_impl()
<a name="55"/>
<a name="56"/>   #
<a name="57"/>   # Poll the queue for an object for t milliseconds.  If an object is
<a name="58"/>   # not received within that time, fail, otherwise return it.
<a name="59"/>   # :Parameters :
<a name="60"/>   # :  `t` - the timeout
<a name="61"/>   #
<a name="62"/>   public poll(t)
<a name="63"/>      local o, i
<a name="64"/>      t := Prog.get_runtime_millis() + need_integer(t, 0)
<a name="65"/>      repeat {
<a name="66"/>         if o := attempt() then
<a name="67"/>            return o
<a name="68"/>         i := t - Prog.get_runtime_millis()
<a name="69"/>         if i &lt;= 0 then
<a name="70"/>            fail
<a name="71"/>         i &gt;:= 50
<a name="72"/>         delay(i)
<a name="73"/>      }
<a name="74"/>   end
<a name="75"/>
<a name="76"/>   #
<a name="77"/>   # Clean up the resources used by the queue.  This should be called by
<a name="78"/>   # the parent process after the queue is no longer needed.
<a name="79"/>   #
<a name="80"/>   public override native close()
<a name="81"/>
<a name="82"/>   #
<a name="83"/>   # Return the underlying id of the queue, failing if it's closed.
<a name="84"/>   #
<a name="85"/>   public get_id()
<a name="86"/>      return .\id
<a name="87"/>   end
<a name="88"/>
<a name="89"/>   private static native open_public_impl()
<a name="90"/>   private static native create_public_impl()
<a name="91"/>   private static native create_private_impl()
<a name="92"/>
<a name="93"/>   private static init()
<a name="94"/>      Class.load_library(\Ipc.LOADED)
<a name="95"/>   end
<a name="96"/>
<a name="97"/>   private new(id)
<a name="98"/>      self.id := id
<a name="99"/>      return
<a name="100"/>   end
<a name="101"/>
<a name="102"/>   #
<a name="103"/>   # Get an existing public queue with the given key, or fail
<a name="104"/>   # if no such queue exists.
<a name="105"/>   #
<a name="106"/>   public static open_public(key)
<a name="107"/>      ipc_available() | fail
<a name="108"/>      return Msg(open_public_impl(key))
<a name="109"/>   end
<a name="110"/>
<a name="111"/>   #
<a name="112"/>   # Create a new public queue with the given key
<a name="113"/>   #
<a name="114"/>   public static create_public(key)
<a name="115"/>      ipc_available() | fail
<a name="116"/>      return Msg(create_public_impl(key))
<a name="117"/>   end
<a name="118"/>
<a name="119"/>   #
<a name="120"/>   # Create a new private queue
<a name="121"/>   #
<a name="122"/>   public static create_private()
<a name="123"/>      ipc_available() | fail
<a name="124"/>      return Msg(create_private_impl())
<a name="125"/>   end
<a name="126"/>end
</pre></body></html>
