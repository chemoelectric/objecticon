<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>menubutton.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: menubutton.icn 7813 2019-08-04 16:06:19Z rparlett $
<a name="3"/>#
<a name="4"/># This file is in the public domain.
<a name="5"/>#
<a name="6"/># Author: Robert Parlett (parlett@dial.pipex.com)
<a name="7"/>#
<a name="8"/>
<a name="9"/>package gui
<a name="10"/>
<a name="11"/>import graphics
<a name="12"/>
<a name="13"/>#
<a name="14"/># This is similar to `MenuBar`, but holds just a single
<a name="15"/># drop-down menu, rather than several.  It may be placed anywhere on
<a name="16"/># the dialog, whereas a `MenuBar` would invariably be placed along the top.
<a name="17"/>#
<a name="18"/>class MenuButton(BorderWhilstEntered, MenuSystem, Component)
<a name="19"/>   public 
<a name="20"/>      menu, 
<a name="21"/>      which_open
<a name="22"/>
<a name="23"/>   #
<a name="24"/>   # Set the menu to be displayed when the component is clicked.
<a name="25"/>   # :Parameters :
<a name="26"/>   # :  `c` - The `Menu`.
<a name="27"/>   #
<a name="28"/>   public set_menu(c)
<a name="29"/>      (\self.menu).set_component_link(&amp;null)
<a name="30"/>      if is_initialized() then {
<a name="31"/>         (\self.menu).finally()
<a name="32"/>         self.menu := c
<a name="33"/>         c.set_component_link(self)         
<a name="34"/>         self.menu.initially()
<a name="35"/>      } else {
<a name="36"/>         self.menu := c
<a name="37"/>         c.set_component_link(self)         
<a name="38"/>      }
<a name="39"/>      link
<a name="40"/>   end
<a name="41"/>
<a name="42"/>   public override initially()
<a name="43"/>      \self.menu | runerr("No menu set")
<a name="44"/>      Component.initially()
<a name="45"/>      self.menu.initially()
<a name="46"/>   end
<a name="47"/>
<a name="48"/>   public override finally()
<a name="49"/>      if \self.which_open then
<a name="50"/>         self.close_menu()
<a name="51"/>      self.menu.finally()
<a name="52"/>      Component.finally()
<a name="53"/>   end
<a name="54"/>
<a name="55"/>   public override display()
<a name="56"/>      menu.draw_label(self.cbwin, 0, menu.label_w, 0)
<a name="57"/>      if menu.is_shaded() then
<a name="58"/>         Gui.style.shade_rectangle(self.cbwin,
<a name="59"/>                                    self.x, self.y, self.w, self.h)
<a name="60"/>      if /border_whilst_entered_flag | \which_open | (is_unshaded() &amp; \entered) then
<a name="61"/>         border.draw_rect(self.cbwin, self)
<a name="62"/>   end
<a name="63"/>
<a name="64"/>   public open_menu()
<a name="65"/>      self.parent_dialog.enter_menu_mode(self) | fail
<a name="66"/>      self.which_open := self.menu
<a name="67"/>      self.menu.show(self.x,
<a name="68"/>                     self.y + self.h,, self.y)
<a name="69"/>      invalidate()
<a name="70"/>      link
<a name="71"/>   end
<a name="72"/>
<a name="73"/>   public close_menu()
<a name="74"/>      self.menu.hide()
<a name="75"/>      self.which_open := &amp;null
<a name="76"/>      self.parent_dialog.exit_menu_mode(self)
<a name="77"/>      invalidate()
<a name="78"/>      link
<a name="79"/>   end
<a name="80"/>
<a name="81"/>   public override close_all()
<a name="82"/>      close_menu()
<a name="83"/>   end
<a name="84"/>
<a name="85"/>   public override make_partial()
<a name="86"/>      close_menu()
<a name="87"/>   end
<a name="88"/>
<a name="89"/>   public override go_right()
<a name="90"/>   end
<a name="91"/>
<a name="92"/>   public override go_left()
<a name="93"/>   end
<a name="94"/>
<a name="95"/>   public handle_press(e)
<a name="96"/>      if /self.which_open then {
<a name="97"/>         if menu.is_unshaded() then
<a name="98"/>            self.open_menu()
<a name="99"/>      } else
<a name="100"/>         self.close_menu()
<a name="101"/>   end
<a name="102"/>
<a name="103"/>   public override handle_accel(e)
<a name="104"/>      if /self.which_open then
<a name="105"/>         self.open_menu() | fail
<a name="106"/>      self.menu.cursor_on()
<a name="107"/>      # See comment in MenuBar.handle_accel
<a name="108"/>      menu.accel_skip := e
<a name="109"/>   end
<a name="110"/>
<a name="111"/>   public override match_accel(e)
<a name="112"/>      succeed self.menu.accel === e &amp; menu.is_unshaded()
<a name="113"/>   end
<a name="114"/>
<a name="115"/>   public override should_close(e)
<a name="116"/>      succeed member(Mouse.PRESS, e.code) &amp; not(in_region(e))
<a name="117"/>   end
<a name="118"/>
<a name="119"/>   public override get_tooltip(e)
<a name="120"/>      return \self.tooltip | 
<a name="121"/>         (menu.in_label_region(e) &amp; menu.get_tooltip(e))
<a name="122"/>   end
<a name="123"/>
<a name="124"/>   public override get_default_width()
<a name="125"/>      return self.menu.get_label_mid_width() + border.get_total_width()
<a name="126"/>   end
<a name="127"/>
<a name="128"/>   public override get_default_height()
<a name="129"/>      return self.menu.get_label_mid_height() + border.get_total_height()
<a name="130"/>   end
<a name="131"/>
<a name="132"/>   public override layout()
<a name="133"/>      self.menu.label_x := self.x + border.get_l_inset()
<a name="134"/>      self.menu.label_y := self.y + border.get_t_inset()
<a name="135"/>      self.menu.label_w := self.w - border.get_total_width()
<a name="136"/>      self.menu.label_h := self.h - border.get_total_height()
<a name="137"/>   end
<a name="138"/>
<a name="139"/>   public override shift(dx, dy)
<a name="140"/>      Component.shift(dx, dy)
<a name="141"/>      self.menu.label_x +:= dx
<a name="142"/>      self.menu.label_y +:= dy
<a name="143"/>   end
<a name="144"/>
<a name="145"/>   public override allow_nested(c)
<a name="146"/>      succeed is(c, SubMenuProxyComponent) &amp; c.menu.parent_component === self
<a name="147"/>   end
<a name="148"/>
<a name="149"/>   public override gen_popup_components()
<a name="150"/>   end
<a name="151"/>
<a name="152"/>   public override get_nesting_component()
<a name="153"/>      link
<a name="154"/>   end
<a name="155"/>
<a name="156"/>   public override new()
<a name="157"/>      Component.new()
<a name="158"/>      BorderWhilstEntered.new()
<a name="159"/>      self.set_border(RaisedBorder())
<a name="160"/>      every connect(handle_press, Event.MOUSE_LEFT_PRESS | Event.MOUSE_MIDDLE_PRESS | Event.MOUSE_RIGHT_PRESS)
<a name="161"/>      return
<a name="162"/>   end
<a name="163"/>end
</pre></body></html>
