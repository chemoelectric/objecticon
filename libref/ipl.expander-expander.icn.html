<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>expander.icn</title></head><body><pre>
<a name="1"/>############################################################################
<a name="2"/>#
<a name="3"/>#	File:     expander.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures to convert character pattern expressions
<a name="6"/>#
<a name="7"/>#	Author:   Ralph E. Griswold
<a name="8"/>#
<a name="9"/>#	Date:     May 2, 2001
<a name="10"/>#
<a name="11"/>############################################################################
<a name="12"/>#
<a name="13"/>#  This file is in the public domain.
<a name="14"/>#
<a name="15"/>############################################################################
<a name="16"/>#
<a name="17"/>#  pfl2str(pattern) expands pattern-form expressions, which have the form
<a name="18"/>#
<a name="19"/>#	[&lt;expr&gt;&lt;op&gt;&lt;expr&gt;]
<a name="20"/>#
<a name="21"/>#  to the corresponding string.
<a name="22"/>#
<a name="23"/>#  The value of &lt;op&gt; determines the operation to be performed.
<a name="24"/>#
<a name="25"/>#  pfl2gxp(pattern) expands pattern-form expressions into generators
<a name="26"/>#  that, when compiled and evaluated, produce the corresponding
<a name="27"/>#  string.
<a name="28"/>#
<a name="29"/>#  pfl2pwl(pattern) converts pattern-form expressions to Painter's
<a name="30"/>#  weaving language.
<a name="31"/>#
<a name="32"/>###########################################################################n
<a name="33"/>#
<a name="34"/>#  Links:  strings, weaving
<a name="35"/>#
<a name="36"/>############################################################################
<a name="37"/>
<a name="38"/>package ipl.expander
<a name="39"/>
<a name="40"/>import
<a name="41"/>   io(ewrite),
<a name="42"/>   ipl.strings(collate, deletec, replacem, rotate),
<a name="43"/>   ipl.weaving(Block, DownUp, Downto, Extend,
<a name="44"/>               Interleave, Palindrome, Pbox, Permute,
<a name="45"/>               Template, UpDown, Upto),
<a name="46"/>   lang(Prog)
<a name="47"/>
<a name="48"/># pattern-form to plain string
<a name="49"/>procedure pfl2str(pattern)		
<a name="50"/>   local result, expr1, expr2, op
<a name="51"/>   static operator, optbl
<a name="52"/>
<a name="53"/>   initial {
<a name="54"/>      operator := '*\-!|+,/~:?%&lt;&gt;#`'
<a name="55"/>
<a name="56"/>      optbl := table()
<a name="57"/>
<a name="58"/>      optbl["*"] := repl
<a name="59"/>      optbl["&lt;"] := Upto
<a name="60"/>      optbl["&gt;"] := Downto
<a name="61"/>      optbl["-"] := UpDown
<a name="62"/>      optbl["|"] := Palindrome
<a name="63"/>#     optbl["!"] := Palindroid
<a name="64"/>      optbl["+"] := Block
<a name="65"/>      optbl["~"] := Interleave
<a name="66"/>      optbl["-&gt;"] := Extend
<a name="67"/>      optbl[":"] := Template
<a name="68"/>      optbl["?"] := Permute
<a name="69"/>      optbl["%"] := Pbox
<a name="70"/>      optbl["&lt;&gt;"] := UpDown
<a name="71"/>      optbl["&gt;&lt;"] := DownUp
<a name="72"/>      optbl["#"] := rotate
<a name="73"/>      optbl["`"] := reverse
<a name="74"/>      optbl[","] := Prog.get_operator("||", 2)
<a name="75"/>      }
<a name="76"/>
<a name="77"/>   result := ""
<a name="78"/>
<a name="79"/>   pattern ? {
<a name="80"/>      while result ||:= tab(upto('[')) do {
<a name="81"/>         move(1)
<a name="82"/>#        expr1 := pfl2str(tab(bal(operator, '[', ']'))) | return error("1", pattern)
<a name="83"/>         unless expr1 := pfl2str(tab(bal(operator, '[', ']'))) then {
<a name="84"/>            result ||:= pfl2str(tab(bal(']', '[', ']')))
<a name="85"/>            move(1)
<a name="86"/>            next
<a name="87"/>            }
<a name="88"/>         op := tab(many(operator)) | return error("2", pattern)
<a name="89"/>         expr2 := pfl2str(tab(bal(']', '[', ']'))) | return error("3", pattern)
<a name="90"/>         result ||:= \optbl[op](expr1, expr2) | return error("4", pattern)
<a name="91"/>         move(1)
<a name="92"/>         }
<a name="93"/>      unless pos(0) then result ||:= tab(0)
<a name="94"/>      }
<a name="95"/>
<a name="96"/>   return result
<a name="97"/>
<a name="98"/>end
<a name="99"/>
<a name="100"/># pattern form to Painter expression
<a name="101"/>procedure pfl2pwl(pattern)		
<a name="102"/>   local result,     expr1, expr2, op, head
<a name="103"/>   static operator, optbl
<a name="104"/>
<a name="105"/>   initial {
<a name="106"/>      operator := '*\-!|+,;/~:?%&lt;&gt;#`'
<a name="107"/>
<a name="108"/>      optbl := table()
<a name="109"/>
<a name="110"/>      optbl["*"] := "*"
<a name="111"/>      optbl["&lt;"] := "&lt;"
<a name="112"/>      optbl["&gt;"] := "&gt;"
<a name="113"/>      optbl["-"] := "-"
<a name="114"/>      optbl["|"] := "|"
<a name="115"/>      optbl["!"] := "!"		# not supported in PWL
<a name="116"/>      optbl["+"] := "[]"
<a name="117"/>      optbl["-&gt;"] := "-&gt;"
<a name="118"/>      optbl["~"] := "~"
<a name="119"/>      optbl[":"] := ":"
<a name="120"/>      optbl["?"] := " perm "
<a name="121"/>      optbl["%"] := " pbox "
<a name="122"/>      optbl["&lt;&gt;"] := "&lt;&gt;"
<a name="123"/>      optbl["&gt;&lt;"] := "&gt;&lt;"
<a name="124"/>      optbl["#"] := "#"
<a name="125"/>      optbl["`"] := "`"
<a name="126"/>      optbl[","] := ","
<a name="127"/>      }
<a name="128"/>
<a name="129"/>   result := ""
<a name="130"/>
<a name="131"/>   pattern ? {
<a name="132"/>      while head :=  tab(upto('[')) do {
<a name="133"/>         if *head &gt; 0 then result ||:= "," || head
<a name="134"/>         move(1)
<a name="135"/>         expr1 := pfl2pwl(tab(bal(operator, '[', ']'))) | return error()
<a name="136"/>         op := tab(many(operator)) | return error()
<a name="137"/>         expr2 := pfl2pwl(tab(bal(']', '[', ']'))) | return error()
<a name="138"/>         result ||:= "," ||  "(" || expr1 || \optbl[op] || expr2 || ")" |
<a name="139"/>            return error()
<a name="140"/>         move(1)
<a name="141"/>         }
<a name="142"/>      unless pos(0) then result ||:= "," || tab(0)
<a name="143"/>      }
<a name="144"/>
<a name="145"/>   return result[2:0]
<a name="146"/>
<a name="147"/>end
<a name="148"/>
<a name="149"/>procedure error(expr1, expr2)
<a name="150"/>
<a name="151"/>   ewrite("*** error ", expr1, " ", expr2)
<a name="152"/>
<a name="153"/>   fail
<a name="154"/>
<a name="155"/>end
<a name="156"/>
<a name="157"/># pattern form to generating expression
<a name="158"/>procedure pfl2gxp(pattern, arg)		
<a name="159"/>   local result,     expr1, expr2, op
<a name="160"/>   static operator, optbl, argtbl
<a name="161"/>
<a name="162"/>   initial {
<a name="163"/>
<a name="164"/>      operator := ',.*\-!|+;/~:?%&lt;&gt;#`'
<a name="165"/>
<a name="166"/>      optbl := table()
<a name="167"/>
<a name="168"/>      optbl["*"] := "Repl{"
<a name="169"/>      optbl["&lt;"] := "Upto{"
<a name="170"/>      optbl["&gt;"] := "Downto{"
<a name="171"/>      optbl["-"] := "UpDownto{"
<a name="172"/>      optbl["|"] := "TileMirror{"
<a name="173"/>      optbl["!"] := "Palin{"
<a name="174"/>      optbl["+"] := "Valrpt{"
<a name="175"/>      optbl["~"] := "Inter{"
<a name="176"/>      optbl["-&gt;"] := "ExtendSeq{"
<a name="177"/>      optbl["~"] := "Parallel{"
<a name="178"/>      optbl[":"] := "Template{"
<a name="179"/>      optbl["?"] := "Permut{"
<a name="180"/>      optbl["%"] := "Pbox{"
<a name="181"/>      optbl["&lt;&gt;"] := "UpDown{"
<a name="182"/>      optbl["&gt;&lt;"] := "DownUp{"
<a name="183"/>      optbl["#"] := "Rotate{"
<a name="184"/>      optbl["`"] := "Reverse{"
<a name="185"/>      optbl["*"] := repl
<a name="186"/>      }
<a name="187"/>
<a name="188"/>   /arg := str
<a name="189"/>
<a name="190"/>      # Handling of literal arguments
<a name="191"/>
<a name="192"/>      argtbl := table(str)
<a name="193"/>      argtbl["*"] := 1
<a name="194"/>      argtbl["#"] := 1
<a name="195"/>      argtbl["-&gt;"] := 1
<a name="196"/>
<a name="197"/>   if /pattern | (*pattern = 0) then return image("")
<a name="198"/>
<a name="199"/>   result := ""
<a name="200"/>
<a name="201"/>   pattern ? {
<a name="202"/>      while result ||:= arg(tab(upto('['))) do {
<a name="203"/>         move(1)
<a name="204"/>         unless expr1 := pfl2gxp(tab(bal(operator, '[', ']')), arg) then {
<a name="205"/>            result ||:= tab(bal(']', '[', ']')) || " | "	# no operator
<a name="206"/>            move(1)
<a name="207"/>            next
<a name="208"/>            }
<a name="209"/>         if ="." then result ||:= tab(bal(']', '[', ']')) || " | "
<a name="210"/>         else {
<a name="211"/>            op := tab(many(operator))  | return error()
<a name="212"/>            expr2 := pfl2gxp(tab(bal(']', '[', ']')), argtbl[op]) | return error()
<a name="213"/>            result ||:= \optbl[op] || expr1 || "," || expr2 || ") | " |
<a name="214"/>              return error()
<a name="215"/>            }
<a name="216"/>         move(1)
<a name="217"/>         }
<a name="218"/>      unless pos(0) then result ||:= arg(tab(0))
<a name="219"/>      }
<a name="220"/>
<a name="221"/>   return trim(result, '| ')
<a name="222"/>
<a name="223"/>end
<a name="224"/>
<a name="225"/>procedure lit(s)
<a name="226"/>
<a name="227"/>   return "!" || image(s)
<a name="228"/>
<a name="229"/>end
<a name="230"/>
<a name="231"/>procedure str(s)
<a name="232"/>
<a name="233"/>   return lit(s) || " | "
<a name="234"/>
<a name="235"/>end
<a name="236"/>
<a name="237"/>procedure galt(s)
<a name="238"/>
<a name="239"/>   return "Galt{" || collate(s, repl(",", *s - 1)) || "}"
<a name="240"/>
<a name="241"/>end
<a name="242"/>
<a name="243"/># Painter expression to pattern form
<a name="244"/>procedure pwl2pfl(wexpr)		
<a name="245"/>
<a name="246"/>   return pwlcvt(prepare(wexpr))
<a name="247"/>
<a name="248"/>end
<a name="249"/>
<a name="250"/># preprocess pwl
<a name="251"/>procedure prepare(wexpr)		
<a name="252"/>   local inter, result
<a name="253"/>   static names, names1
<a name="254"/>
<a name="255"/>   initial {
<a name="256"/>      names := [
<a name="257"/>         "",				# expression placeholder
<a name="258"/>         " block ", "[]",
<a name="259"/>         " repeat ", "*",
<a name="260"/>         " rep ", "*",
<a name="261"/>         " extend ", "==",
<a name="262"/>         " ext ", "==",
<a name="263"/>         " concat ", ",",
<a name="264"/>         " interleave ", "~",
<a name="265"/>         " int ", "~",
<a name="266"/>         " upto ", "&gt;",
<a name="267"/>         " downto ", "&lt;",
<a name="268"/>         " template ", ":",
<a name="269"/>         " temp ", ":",
<a name="270"/>         " palindrome ", "|",
<a name="271"/>         " pal ", "|",
<a name="272"/>         " pal", "|",
<a name="273"/>         " permute ", "?",
<a name="274"/>         " perm ", "?",
<a name="275"/>         " pbox ", "%",
<a name="276"/>         " updown ", "&lt;&gt;",
<a name="277"/>         " downup ", "&gt;&lt;",
<a name="278"/>         " rotate ", "#",
<a name="279"/>         " rot ", "#",
<a name="280"/>         " reverse ", "`",
<a name="281"/>         " rev ", "`",
<a name="282"/>         " rev", "`",
<a name="283"/>         ]
<a name="284"/>
<a name="285"/>      names1 := [
<a name="286"/>         "",				# expression placeholder
<a name="287"/>         "pal", "|",
<a name="288"/>         "rev", "`"
<a name="289"/>         ]
<a name="290"/>
<a name="291"/>      }
<a name="292"/>
<a name="293"/>   result := ""
<a name="294"/>
<a name="295"/>   wexpr ? {
<a name="296"/>      while result ||:= tab(upto('[')) do {
<a name="297"/>         move(1)
<a name="298"/>         inter := tab(bal(']'))
<a name="299"/>         if *inter &gt; 0 then result ||:= spray(inter)
<a name="300"/>         else result ||:= "[]"
<a name="301"/>         move(1)
<a name="302"/>         }
<a name="303"/>      result ||:= tab(0)
<a name="304"/>      }
<a name="305"/>
<a name="306"/>   if upto(result, ' ') then {
<a name="307"/>      if upto(result, &amp;letters) then {
<a name="308"/>         names[1] := result
<a name="309"/>         result := (replacem ! names)
<a name="310"/>         }
<a name="311"/>      }
<a name="312"/>
<a name="313"/>   if upto(result, &amp;letters) then {
<a name="314"/>      names1[1] := result
<a name="315"/>      result := (replacem ! names1)
<a name="316"/>      }
<a name="317"/>
<a name="318"/>   return deletec(map(result, "[]", "=="), ' ')
<a name="319"/>
<a name="320"/>end
<a name="321"/>
<a name="322"/>procedure pwlcvt(wexpr)
<a name="323"/>   local result
<a name="324"/>
<a name="325"/>   wexpr ?:= {
<a name="326"/>      2(="(", tab(bal(')')), pos(-1))
<a name="327"/>      }
<a name="328"/>      
<a name="329"/>   result := ""
<a name="330"/>
<a name="331"/>   wexpr ? {
<a name="332"/>      while result ||:= form1(pwlcvt(tab(bal('|`', '([', ']('))), move(1))
<a name="333"/>      result ||:= tab(0)
<a name="334"/>      }
<a name="335"/>
<a name="336"/>   wexpr := result
<a name="337"/>   result := ""
<a name="338"/>
<a name="339"/>   wexpr ? {
<a name="340"/>      while result ||:= form2(pwlcvt(tab(bal('\-&gt;:#*=~', '([', ')]'))),
<a name="341"/>         =("#" | "*" | "-&gt;" | "~" | ":" | "=="), pwlcvt(tab(0)))
<a name="342"/>      result ||:= tab(0)
<a name="343"/>      }
<a name="344"/>
<a name="345"/>   wexpr := result
<a name="346"/>   result := ""
<a name="347"/> 
<a name="348"/>   wexpr ? {
<a name="349"/>      while result ||:= form2(pwlcvt(tab(bal('&lt;&gt;', '([', ')]'))),
<a name="350"/>         =("&gt;&lt;" | "&lt;&gt;"), pwlcvt(tab(0)))
<a name="351"/>      result ||:= tab(0)
<a name="352"/>      }
<a name="353"/>
<a name="354"/>   wexpr := result
<a name="355"/>   result := ""
<a name="356"/> 
<a name="357"/>   wexpr ? {
<a name="358"/>      while result ||:= form2(pwlcvt(tab(bal('&lt;\-&gt;,', '([', ')]'))),
<a name="359"/>         =("&gt;" | "&lt;" | "-" | ","), pwlcvt(tab(0)))
<a name="360"/>      result ||:= tab(0)
<a name="361"/>      }
<a name="362"/>      
<a name="363"/>   return result
<a name="364"/>
<a name="365"/>end
<a name="366"/>
<a name="367"/>procedure form1(wexpr, op)
<a name="368"/>
<a name="369"/>   return "[" || wexpr || op || "]"
<a name="370"/>
<a name="371"/>end
<a name="372"/>
<a name="373"/>procedure form2(wexpr1, op, wexpr2)
<a name="374"/>
<a name="375"/>   return "[" || wexpr1 || op || wexpr2 || "]"
<a name="376"/>
<a name="377"/>end
<a name="378"/>
<a name="379"/>procedure spray(inter)
<a name="380"/>   local count, s1, s2, s3, colors
<a name="381"/>
<a name="382"/>   s1 := s2 := s3 := ""
<a name="383"/>
<a name="384"/>   inter ?:= {		# only palindome and reflection allowed, it seems
<a name="385"/>      1(tab(upto('|`') | 0), s3 := tab(0))
<a name="386"/>      }
<a name="387"/>
<a name="388"/>   inter ? {
<a name="389"/>      while s1 ||:= colors := tab(upto(' ')) do {
<a name="390"/>         tab(many(' '))
<a name="391"/>         count := tab(upto(' ') | 0)
<a name="392"/>         if *count = 1 then s2 ||:= repl(count, *colors)
<a name="393"/>         else s2 ||:= repl("{" || count || "}", *colors)
<a name="394"/>         move(1) | break
<a name="395"/>         }
<a name="396"/>      }
<a name="397"/>   
<a name="398"/>   return "((" || s1 || s3 || ")" || "[]" || s2 || ")"
<a name="399"/>
<a name="400"/>end
</pre></body></html>
