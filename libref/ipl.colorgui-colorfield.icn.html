<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>colorfield.icn</title></head><body><pre>
<a name="1"/>package ipl.colorgui
<a name="2"/>
<a name="3"/>import
<a name="4"/>   gui, graphics, util
<a name="5"/>
<a name="6"/>#
<a name="7"/># A component for choosing a color, in icon color-string format.
<a name="8"/>#
<a name="9"/>class ColorField(Component)
<a name="10"/>   private readable
<a name="11"/>      b,
<a name="12"/>      cr,
<a name="13"/>      tf,
<a name="14"/>      last_val,
<a name="15"/>      opaque_flag
<a name="16"/>
<a name="17"/>   # If set, the field will only allow opaque colors to be entered.
<a name="18"/>   #
<a name="19"/>   public set_opaque(s)
<a name="20"/>      self.opaque_flag := need_flag(s)
<a name="21"/>      link
<a name="22"/>   end
<a name="23"/>
<a name="24"/>   public on_textfield(ev, src, type)
<a name="25"/>      if last_val := get_value() then {
<a name="26"/>         tf.remove_wattrib(WAttrib.FG).reset()
<a name="27"/>         cr.set_color(last_val)
<a name="28"/>      } else {
<a name="29"/>         tf.set_fg(Style.ERROR_COLOR).reset()
<a name="30"/>         cr.set_color("white")
<a name="31"/>      }
<a name="32"/>   end
<a name="33"/>
<a name="34"/>   public override initially()
<a name="35"/>      Component.initially()
<a name="36"/>      tf.set_width(cbwin.text_width(if /opaque_flag then "00000,00000,00000,00000 " else "00000,00000,00000 ") + tf.border.get_total_width())
<a name="37"/>   end
<a name="38"/>
<a name="39"/>   # Return the value (as an integer form icon color value), or fail
<a name="40"/>   # if the input is not currently valid.
<a name="41"/>   #
<a name="42"/>   public get_value()
<a name="43"/>      local c
<a name="44"/>      c := Window.color_value(tf.get_contents()) | fail
<a name="45"/>      if \opaque_flag &amp; Window.parse_color(c).alpha ~= 65535 then
<a name="46"/>         fail
<a name="47"/>      return c
<a name="48"/>   end
<a name="49"/>
<a name="50"/>   # Set the value (from an icon color value).  Fails if `s` is not a
<a name="51"/>   # valid color.
<a name="52"/>   #
<a name="53"/>   public set_value(s)
<a name="54"/>      s := Window.color_value(s) | fail
<a name="55"/>      if \opaque_flag &amp; Window.parse_color(s).alpha ~= 65535 then
<a name="56"/>         fail
<a name="57"/>      tf.set_contents(s)
<a name="58"/>      last_val := s
<a name="59"/>      cr.set_color(last_val)
<a name="60"/>      if is_live() then
<a name="61"/>         tf.remove_wattrib(WAttrib.FG).reset()
<a name="62"/>      link
<a name="63"/>   end
<a name="64"/>
<a name="65"/>   # Set the value as above, but firing events.
<a name="66"/>   #
<a name="67"/>   public assign_value(s, ev, coalesce)
<a name="68"/>      s := Window.color_value(s) | fail
<a name="69"/>      if \opaque_flag &amp; Window.parse_color(s).alpha ~= 65535 then
<a name="70"/>         fail
<a name="71"/>      tf.assign_contents(s,, ev, coalesce)
<a name="72"/>      link
<a name="73"/>   end
<a name="74"/>
<a name="75"/>   private on_choose(ev)
<a name="76"/>      local d
<a name="77"/>      d := ColorDialog(last_val).set_opaque(opaque_flag)
<a name="78"/>      d.show_modal(parent_dialog)
<a name="79"/>      assign_value(d.get_result(), ev)
<a name="80"/>   end
<a name="81"/>
<a name="82"/>   # Create a new instance optionally with the given initial value of
<a name="83"/>   # the field, as a icon color value.
<a name="84"/>   #
<a name="85"/>   public override new(val)
<a name="86"/>      local p, t
<a name="87"/>      /val := "black"
<a name="88"/>      Component.new() 
<a name="89"/>      set_layout(GridLayout().set_doi(0).set_dii(0))
<a name="90"/>      p := Component().
<a name="91"/>         set_layout(GridLayout().set_doi(0).set_dii(0))
<a name="92"/>      cr := ColorRectangle().
<a name="93"/>         set_size(25, 5).
<a name="94"/>         set_constraint("y_fill", &amp;yes)
<a name="95"/>      p.add(cr)
<a name="96"/>      tf := TextField().
<a name="97"/>         set_border(EmptyBorder().set_l_inset(Gui.TEXT_INSET).set_r_inset(Gui.TEXT_INSET))
<a name="98"/>      tf.connect(on_textfield, Event.CONTENT_CHANGED | Event.ACTION)
<a name="99"/>      p.add(tf)
<a name="100"/>      t := Border().
<a name="101"/>         set_content(p).
<a name="102"/>         set_border(SunkenBorder()).
<a name="103"/>         set_preferred_focus(tf)
<a name="104"/>      add(t)
<a name="105"/>      b := TextButton().
<a name="106"/>         set_label("Choose...").
<a name="107"/>         connect(on_choose, Event.ACTION)
<a name="108"/>      add(b)
<a name="109"/>      set_value(val)
<a name="110"/>      return
<a name="111"/>   end
<a name="112"/>end
</pre></body></html>
