<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>multiparthandler.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: multiparthandler.icn 8996 2021-03-24 07:27:53Z rparlett $
<a name="3"/>#
<a name="4"/>
<a name="5"/>package mail
<a name="6"/>
<a name="7"/>import lang, util(error)
<a name="8"/>
<a name="9"/>class MultipartHandler(TypeHandler)
<a name="10"/>   public override can_handle(ct)
<a name="11"/>      succeed Text.lower(ct.get_type()) == "multipart"
<a name="12"/>   end
<a name="13"/>   
<a name="14"/>   public override convert_to_object(m, data)
<a name="15"/>      local s, res, b, ct, sm
<a name="16"/>
<a name="17"/>      res := Multipart()
<a name="18"/>
<a name="19"/>      ct := m.get_content_type()
<a name="20"/>
<a name="21"/>      b := "\r\n--" || ct.get_parameter("boundary")
<a name="22"/>      if /b then
<a name="23"/>         return error("Missing boundary parameter")
<a name="24"/>
<a name="25"/>      data ? {
<a name="26"/>         if =(b[3:0]) then
<a name="27"/>            # Boundary at start (without CRLF).
<a name="28"/>            res.set_preamble("")
<a name="29"/>         else {
<a name="30"/>            s := tab(find(b)) | return error("Missing boundary")
<a name="31"/>            res.set_preamble(s)
<a name="32"/>            =b
<a name="33"/>         }
<a name="34"/>         repeat {
<a name="35"/>            if ="--\r\n" | (="--" &amp; pos(0)) then
<a name="36"/>               break
<a name="37"/>
<a name="38"/>            ="\r\n" | return error("Unexpected char after boundary")
<a name="39"/>
<a name="40"/>            data := tab(find(b)) | return error("Boundary not found")
<a name="41"/>            =b
<a name="42"/>            sm := Message.parse(data) | fail
<a name="43"/>            res.add_part(sm)
<a name="44"/>         }
<a name="45"/>         res.set_epilogue(tab(0))
<a name="46"/>      }
<a name="47"/>
<a name="48"/>      return res
<a name="49"/>   end
<a name="50"/>
<a name="51"/>   public override convert_from_object(m, obj)
<a name="52"/>      local b, s, ct
<a name="53"/>
<a name="54"/>      b := generate_boundary(obj.get_parts())
<a name="55"/>      
<a name="56"/>      ct := m.get_content_type()
<a name="57"/>
<a name="58"/>      #
<a name="59"/>      # Install the boundary param into the message.
<a name="60"/>      #
<a name="61"/>      ct.set_parameter("boundary", b)
<a name="62"/>      m.set_content_type(ct)
<a name="63"/>
<a name="64"/>      s := obj.get_preamble()
<a name="65"/>      every s ||:= "\r\n--" || b || "\r\n" || (!obj.get_parts()).to_rfc822()
<a name="66"/>      s ||:= "\r\n--" || b || "--\r\n" || obj.get_epilogue()
<a name="67"/>
<a name="68"/>      return s
<a name="69"/>   end
<a name="70"/>
<a name="71"/>   private generate_boundary(l)
<a name="72"/>      local b
<a name="73"/>      static id
<a name="74"/>      initial id := 1
<a name="75"/>
<a name="76"/>      repeat {
<a name="77"/>         b := "boundary" || id
<a name="78"/>         if find(b, (!l).get_content()) then
<a name="79"/>            id +:= 1
<a name="80"/>         else
<a name="81"/>            return b
<a name="82"/>      }
<a name="83"/>   end
<a name="84"/>end
<a name="85"/>
</pre></body></html>
