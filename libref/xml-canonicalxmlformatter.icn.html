<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>canonicalxmlformatter.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: canonicalxmlformatter.icn 8783 2020-12-27 20:18:51Z rparlett $
<a name="3"/>#
<a name="4"/># This file is in the public domain.
<a name="5"/>#
<a name="6"/># Author: Robert Parlett (parlett@dial.pipex.com)
<a name="7"/>#
<a name="8"/>
<a name="9"/>package xml
<a name="10"/>
<a name="11"/>#
<a name="12"/># This is a formatter for outputting XML documents in canonical form, which
<a name="13"/># is used for testing purposes.
<a name="14"/>#
<a name="15"/>class CanonicalXmlFormatter(XmlFormatter)
<a name="16"/>   protected override format_cdata(n)
<a name="17"/>      writes1(xml_escape(n.content, '\n\r\t&amp;&lt;&gt;\"'))
<a name="18"/>   end
<a name="19"/>
<a name="20"/>   protected override format_document(n)
<a name="21"/>      local el
<a name="22"/>      every el := !n.children do {
<a name="23"/>         if is(el, DocType | ProcessingInstruction | Element) then
<a name="24"/>            format_node(el)
<a name="25"/>      }
<a name="26"/>   end
<a name="27"/>
<a name="28"/>   protected override format_doctype(n)
<a name="29"/>      local s, x
<a name="30"/>
<a name="31"/>      if *n.parent.notation_declarations = 0 then
<a name="32"/>         return
<a name="33"/>      
<a name="34"/>      s := "&lt;!DOCTYPE " || n.name
<a name="35"/>      s ||:= " [\n"
<a name="36"/>      every x := !sort(n.parent.notation_declarations) do {
<a name="37"/>         s ||:= "&lt;!NOTATION " || x[1] || " "
<a name="38"/>         if \x[2].public_id then
<a name="39"/>            s ||:= "PUBLIC \'" || x[2].public_id || "\'"
<a name="40"/>         else {
<a name="41"/>            if \x[2].external_id.public_id then
<a name="42"/>               s ||:= "PUBLIC \'" || x[2].external_id.public_id || "\' \'" || x[2].external_id.system_id || "\'"
<a name="43"/>            else
<a name="44"/>               s ||:= "SYSTEM \'" || x[2].external_id.system_id || "\'"
<a name="45"/>         }
<a name="46"/>         s ||:= "&gt;\n"
<a name="47"/>      }
<a name="48"/>      s ||:= "]&gt;\n"
<a name="49"/>      writes1(s)
<a name="50"/>   end
<a name="51"/>
<a name="52"/>   protected override format_element(n)
<a name="53"/>      local s, x, e
<a name="54"/>
<a name="55"/>      s := "&lt;" || n.name
<a name="56"/>      if *n.attributes &gt; 0 then {
<a name="57"/>         s ||:= " "
<a name="58"/>         every x := !sort(n.attributes) do {
<a name="59"/>            s ||:= x[1] || "=\"" || xml_escape(x[2], '\n\r\t&amp;&lt;&gt;\"') || "\" "
<a name="60"/>         }
<a name="61"/>         s[-1] := ""
<a name="62"/>      }
<a name="63"/>      s ||:= "&gt;"
<a name="64"/>      writes1(s)
<a name="65"/>      every e := !n.children do {
<a name="66"/>         if text(e) then
<a name="67"/>            writes1(xml_escape(e, '\n\r\t&amp;&lt;&gt;\"'))
<a name="68"/>         else unless is(e, Comment) then
<a name="69"/>            format_node(e)
<a name="70"/>      }
<a name="71"/>
<a name="72"/>      writes("&lt;/", n.name, "&gt;")
<a name="73"/>   end
<a name="74"/>
<a name="75"/>   protected override format_pi(n)
<a name="76"/>      local s
<a name="77"/>      s := "&lt;?" || n.target || " "
<a name="78"/>      if \n.content then
<a name="79"/>         s ||:= n.content
<a name="80"/>      s ||:= "?&gt;"
<a name="81"/>      writes1(s)
<a name="82"/>   end
<a name="83"/>end
<a name="84"/>
</pre></body></html>
