<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>archives.icn</title></head><body><pre>
<a name="1"/>############################################################################
<a name="2"/>#
<a name="3"/>#	File:     archives.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures for reading files from archives
<a name="6"/>#
<a name="7"/>#	Author:   Gregg M. Townsend
<a name="8"/>#
<a name="9"/>#	Date:     March 5, 2000
<a name="10"/>#
<a name="11"/>############################################################################
<a name="12"/>#
<a name="13"/>#   This file is in the public domain.
<a name="14"/>#
<a name="15"/>############################################################################
<a name="16"/>
<a name="17"/>package ipl.archives
<a name="18"/>
<a name="19"/>import
<a name="20"/>   io(BufferStream, FileStream, FilterInputStream,
<a name="21"/>      LineBasedGeneratorStream, StringStream),
<a name="22"/>   util(error, use)
<a name="23"/>
<a name="24"/># iszip(zname) succeeds if the named file appears to be a ZIP format
<a name="25"/># archive file.
<a name="26"/>#
<a name="27"/>procedure iszip(fname)		
<a name="28"/>   local f
<a name="29"/>   return use {
<a name="30"/>      f := FileStream(fname),
<a name="31"/>      f.reads(4) == "PK\03\04"
<a name="32"/>   }
<a name="33"/>end
<a name="34"/>
<a name="35"/>#
<a name="36"/># `Stream` for reading the entries in an archive, one per line of the stream.
<a name="37"/>#
<a name="38"/>abstract class ArchiveListerStream(LineBasedGeneratorStream)
<a name="39"/>   private
<a name="40"/>      f, bf
<a name="41"/>
<a name="42"/>   public succeeded()
<a name="43"/>      return f.succeeded()
<a name="44"/>   end
<a name="45"/>
<a name="46"/>   public override close()
<a name="47"/>      bf.close() | fail
<a name="48"/>      link
<a name="49"/>   end
<a name="50"/>
<a name="51"/>   protected next_line()
<a name="52"/>      return bf.read_line()
<a name="53"/>   end
<a name="54"/>
<a name="55"/>   protected expect_line()
<a name="56"/>      local s
<a name="57"/>      s := bf.read_line() | fail
<a name="58"/>      return \s | error("Unexpected eof")
<a name="59"/>   end
<a name="60"/>
<a name="61"/>   # Generates the lines of the stream.  End-of-file is signalled by
<a name="62"/>   # returning `&amp;null` and errors are signalled by failing and setting
<a name="63"/>   # `&amp;why`.
<a name="64"/>   #
<a name="65"/>   protected abstract line_gen()
<a name="66"/>
<a name="67"/>   protected override new(prog, args)
<a name="68"/>      self.bf := BufferStream(f := FilterInputStream(, prog, args))
<a name="69"/>      return LineBasedGeneratorStream.new{line_gen()}
<a name="70"/>   end
<a name="71"/>end
<a name="72"/>
<a name="73"/>#
<a name="74"/># `Stream` for reading the entries in a zip archive, one per line of the stream.
<a name="75"/>#
<a name="76"/>class ZipDirStream(ArchiveListerStream)
<a name="77"/>   protected override line_gen()
<a name="78"/>      local s, marker
<a name="79"/>      every 1 to 3 do
<a name="80"/>         expect_line() | fail
<a name="81"/>      marker := "---------                     -------"
<a name="82"/>      repeat {
<a name="83"/>         s := expect_line() | fail
<a name="84"/>         if s == marker then
<a name="85"/>            return
<a name="86"/>         suspend s[31:0]
<a name="87"/>      }
<a name="88"/>   end
<a name="89"/>
<a name="90"/>   public override new(zname)
<a name="91"/>      return ArchiveListerStream.new("unzip", ["-l", zname])
<a name="92"/>   end
<a name="93"/>end
<a name="94"/>
<a name="95"/># zipfile(zname, fname) returns a pipe from which the file fname
<a name="96"/># within the ZIP archive zname can be read.  It is assumed that zname
<a name="97"/># and fname are valid.
<a name="98"/>#
<a name="99"/>procedure zipfile(zname, fname)		
<a name="100"/>   return FilterInputStream(, "unzip", ["-p", zname, fname])
<a name="101"/>end
<a name="102"/>
<a name="103"/>#
<a name="104"/># `Stream` for reading the entries in a rar archive, one per line of the stream.
<a name="105"/>#
<a name="106"/>class RarDirStream(ArchiveListerStream)
<a name="107"/>   protected override line_gen()
<a name="108"/>      local s, marker
<a name="109"/>      every 1 to 8 do
<a name="110"/>         expect_line() | fail
<a name="111"/>      marker := repl("-", 79)
<a name="112"/>      repeat {
<a name="113"/>         s := expect_line() | fail
<a name="114"/>         if s == marker then
<a name="115"/>            return
<a name="116"/>         suspend s[2:0]
<a name="117"/>         expect_line() | fail
<a name="118"/>      }
<a name="119"/>   end
<a name="120"/>
<a name="121"/>   public override new(rname)
<a name="122"/>      return ArchiveListerStream.new("unrar", ["v", "-c-", rname])
<a name="123"/>   end
<a name="124"/>end
<a name="125"/>
<a name="126"/># rarfile(rname, fname) returns a pipe from which the file fname
<a name="127"/># within the rar archive rname can be read.  It is assumed that rname
<a name="128"/># and fname are valid.
<a name="129"/>#
<a name="130"/>procedure rarfile(rname, fname)		
<a name="131"/>   return FilterInputStream(, "unrar", ["p", "-ierr", rname, fname])
<a name="132"/>end
<a name="133"/>
<a name="134"/>#
<a name="135"/># `Stream` for reading the entries in a tar archive, one per line of the stream.
<a name="136"/>#
<a name="137"/>class TarDirStream(ArchiveListerStream)
<a name="138"/>   protected override line_gen()
<a name="139"/>      suspend |next_line()
<a name="140"/>   end
<a name="141"/>
<a name="142"/>   public override new(tname)
<a name="143"/>      return ArchiveListerStream.new("tar", ["tf", tname])
<a name="144"/>   end
<a name="145"/>end
<a name="146"/>
<a name="147"/># tarfile(tname, fname) returns a pipe from which the file fname
<a name="148"/># within the tar archive rname can be read.  It is assumed that tname
<a name="149"/># and fname are valid.
<a name="150"/>#
<a name="151"/>procedure tarfile(tname, fname)		
<a name="152"/>   return FilterInputStream(, "tar", ["xOf", tname, fname])
<a name="153"/>end
<a name="154"/>
<a name="155"/>package procedure run(in, prog, params)
<a name="156"/>   local f, s
<a name="157"/>   if s := use {                         
<a name="158"/>      f := FilterInputStream(in, prog, params),
<a name="159"/>      f.read_all()
<a name="160"/>   } &amp; f.succeeded() then
<a name="161"/>      return s
<a name="162"/>end                                                      
<a name="163"/>
<a name="164"/># Perform gzip on a string, returning the gzipped string.
<a name="165"/>procedure gzip(s)
<a name="166"/>   return run(StringStream(s), "gzip", ["-c"])
<a name="167"/>end
<a name="168"/>
<a name="169"/># Perform gunzip on a string, returning the unzipped string.
<a name="170"/>procedure gunzip(s)
<a name="171"/>   return run(StringStream(s), "gunzip", ["-c"])
<a name="172"/>end
<a name="173"/>
<a name="174"/># Perform gunzip on the given file, returning the unzipped string.
<a name="175"/>procedure gunzip_file(fn)
<a name="176"/>   return run(, "gunzip", ["-c", fn])
<a name="177"/>end
</pre></body></html>
