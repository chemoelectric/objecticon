<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>dataurl.icn</title></head><body><pre>
<a name="1"/>package ipl.dataurl
<a name="2"/>
<a name="3"/>import mail, ipl.base64, util, net
<a name="4"/>
<a name="5"/>#
<a name="6"/># A parser for data: URLs - see rfc 2397.
<a name="7"/>#
<a name="8"/>class DataURL()
<a name="9"/>   public const
<a name="10"/>      content_type,
<a name="11"/>      data
<a name="12"/>
<a name="13"/>   public new(url)
<a name="14"/>      local t, p, e
<a name="15"/>      url.get_path() ? {
<a name="16"/>         t := tab(find(";base64," | ",")) | return error("No , found in data url path")
<a name="17"/>         t ? content_type := if pos(0) then
<a name="18"/>            ContentType("text", "plain").set_parameter("charset", "US-ASCII")
<a name="19"/>         else if ="charset=" then
<a name="20"/>            ContentType("text", "plain").set_parameter("charset", tab(0))
<a name="21"/>         else
<a name="22"/>            RFC822Parser().parse_content_type(t) | return error("Invalid content type in data url: " || &amp;why)
<a name="23"/>         # Remove %encoding from content type parameters
<a name="24"/>         p := content_type.parameters
<a name="25"/>         every e := p.entries() do
<a name="26"/>            p.member(e.key) := URL.percent_decode(e.val)
<a name="27"/>         data := if =";base64," then
<a name="28"/>            base64decode(tab(0)) | return error("Invalid data url: " || &amp;why)
<a name="29"/>         else {
<a name="30"/>            move(1)
<a name="31"/>            URL.percent_decode(tab(0))
<a name="32"/>         }
<a name="33"/>      }
<a name="34"/>      return
<a name="35"/>   end
<a name="36"/>end
</pre></body></html>
