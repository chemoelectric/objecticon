<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>shm.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: shm.icn 8644 2020-11-05 20:30:57Z rparlett $
<a name="3"/>#
<a name="4"/># This file is in the public domain.
<a name="5"/>#
<a name="6"/># Author: Robert Parlett (parlett@dial.pipex.com)
<a name="7"/>#
<a name="8"/>
<a name="9"/>package ipc
<a name="10"/>
<a name="11"/>import lang, util
<a name="12"/>
<a name="13"/>#
<a name="14"/># This class provides an inter process shared variable facility.  The
<a name="15"/># implementation requires the accompanying native library to be on the
<a name="16"/># library path.
<a name="17"/>#
<a name="18"/># Instances of this class should not be created directly, but rather
<a name="19"/># using the static methods `open_public`, `create_public` and
<a name="20"/># `create_private`
<a name="21"/>#
<a name="22"/>final class Shm(NoCopy, HasClose)
<a name="23"/>   private 
<a name="24"/>      id
<a name="25"/>
<a name="26"/>   #
<a name="27"/>   # Set the value to the given object.  The object may be an arbitrary
<a name="28"/>   # Icon structure, and will be encoded into a string by the `encode()`
<a name="29"/>   # procedure.  This method will fail if the given object is not
<a name="30"/>   # encodable, and set `&amp;why` appropriately.
<a name="31"/>   #
<a name="32"/>   public set_value(o)
<a name="33"/>      return set_value_impl(encode(o, &amp;yes))
<a name="34"/>   end
<a name="35"/>
<a name="36"/>   private native set_value_impl(s)
<a name="37"/>
<a name="38"/>   #
<a name="39"/>   # Get the value of the object.
<a name="40"/>   #
<a name="41"/>   public get_value()
<a name="42"/>      return decode(get_value_impl())
<a name="43"/>   end
<a name="44"/>
<a name="45"/>   private native get_value_impl()
<a name="46"/>
<a name="47"/>   #
<a name="48"/>   # Clean up the resources used by the variable.  This should be called by
<a name="49"/>   # the parent process after the shared variable is no longer needed.
<a name="50"/>   #
<a name="51"/>   public override native close()
<a name="52"/>
<a name="53"/>   #
<a name="54"/>   # Return the underlying id of the shared variable; fails if the
<a name="55"/>   # resource is closed.
<a name="56"/>   #
<a name="57"/>   public get_id()
<a name="58"/>      return .\id
<a name="59"/>   end
<a name="60"/>
<a name="61"/>   private static native open_public_impl()
<a name="62"/>   private static native create_public_impl()
<a name="63"/>   private static native create_private_impl()
<a name="64"/>
<a name="65"/>   private static init()
<a name="66"/>      Class.load_library(\Ipc.LOADED)
<a name="67"/>   end
<a name="68"/>
<a name="69"/>   private new(id)
<a name="70"/>      self.id := id
<a name="71"/>      return
<a name="72"/>   end
<a name="73"/>
<a name="74"/>   #
<a name="75"/>   # Get an existing public shared variable with the given key, or fail
<a name="76"/>   # if no such shared variable exists.
<a name="77"/>   #
<a name="78"/>   public static open_public(key)
<a name="79"/>      ipc_available() | fail
<a name="80"/>      return Shm(open_public_impl(key))
<a name="81"/>   end
<a name="82"/>
<a name="83"/>   #
<a name="84"/>   # Create a new public shared variable with the given key and
<a name="85"/>   # initial value
<a name="86"/>   #
<a name="87"/>   public static create_public(key, o)
<a name="88"/>      ipc_available() | fail
<a name="89"/>      return Shm(create_public_impl(key, encode(o, &amp;yes)))
<a name="90"/>   end
<a name="91"/>
<a name="92"/>   #
<a name="93"/>   # Create a new private shared variable with the given initial value
<a name="94"/>   #
<a name="95"/>   public static create_private(o)
<a name="96"/>      ipc_available() | fail
<a name="97"/>      return Shm(create_private_impl(encode(o, &amp;yes)))
<a name="98"/>   end
<a name="99"/>end
</pre></body></html>
