<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>message.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: message.icn 7415 2019-01-25 16:51:58Z rparlett $
<a name="3"/>#
<a name="4"/>
<a name="5"/>package mail
<a name="6"/>
<a name="7"/>import util, io, ipl.pdco(String, List)
<a name="8"/>
<a name="9"/>#
<a name="10"/># This class represents an email message
<a name="11"/>#
<a name="12"/>class Message(MimeHeaders)
<a name="13"/>   private readable 
<a name="14"/>      content
<a name="15"/>
<a name="16"/>   #
<a name="17"/>   # Set the content
<a name="18"/>   #
<a name="19"/>   public set_content(s)
<a name="20"/>      self.content := need_string(s)
<a name="21"/>      link
<a name="22"/>   end
<a name="23"/>
<a name="24"/>   #
<a name="25"/>   # Get the content
<a name="26"/>   #
<a name="27"/>   public get_content()
<a name="28"/>      return content
<a name="29"/>   end
<a name="30"/>
<a name="31"/>   #
<a name="32"/>   # Get the decoded content, based on the Content-Transfer-Encoding attribute.
<a name="33"/>   #
<a name="34"/>   public get_decoded_content()
<a name="35"/>      local h
<a name="36"/>
<a name="37"/>      #
<a name="38"/>      # Get the handler
<a name="39"/>      #
<a name="40"/>      h := get_encoding_handler() | fail
<a name="41"/>
<a name="42"/>      #
<a name="43"/>      # Use the handler to convert the data.
<a name="44"/>      #
<a name="45"/>      return h.decode_data(self, content)
<a name="46"/>   end
<a name="47"/>
<a name="48"/>   #
<a name="49"/>   # Set the decoded content.  The content itself will then be set based on the
<a name="50"/>   # Content-Transfer-Encoding.
<a name="51"/>   #
<a name="52"/>   public set_decoded_content(s)
<a name="53"/>      local h
<a name="54"/>
<a name="55"/>      s := need_string(s)
<a name="56"/>
<a name="57"/>      #
<a name="58"/>      # Get the handler
<a name="59"/>      #
<a name="60"/>      h := get_encoding_handler() | fail
<a name="61"/>
<a name="62"/>      #
<a name="63"/>      # Use the handler to convert the data.
<a name="64"/>      #
<a name="65"/>      content := h.encode_data(self, s)
<a name="66"/>      link
<a name="67"/>   end
<a name="68"/>
<a name="69"/>   #
<a name="70"/>   # Retrieve an object representation of the decoded data, based on
<a name="71"/>   # the Content-Type attribute.
<a name="72"/>   #
<a name="73"/>   public get_content_object()
<a name="74"/>      local data, h
<a name="75"/>
<a name="76"/>      data := get_decoded_content() | fail
<a name="77"/>
<a name="78"/>      #
<a name="79"/>      # Get the handler
<a name="80"/>      #
<a name="81"/>      h := get_type_handler() | fail
<a name="82"/>
<a name="83"/>      #
<a name="84"/>      # Use the handler to convert the data.
<a name="85"/>      #
<a name="86"/>      return h.convert_to_object(self, data)
<a name="87"/>   end
<a name="88"/>
<a name="89"/>   #
<a name="90"/>   # Set the content from the given object, which must be consistent
<a name="91"/>   # with the Content-Type specified in the message.
<a name="92"/>   #
<a name="93"/>   public set_content_object(o)
<a name="94"/>      local data, h
<a name="95"/>
<a name="96"/>      #
<a name="97"/>      # Get the handler
<a name="98"/>      #
<a name="99"/>      h := get_type_handler() | fail
<a name="100"/>
<a name="101"/>      data := h.convert_from_object(self, o) | fail
<a name="102"/>
<a name="103"/>      return set_decoded_content(data)
<a name="104"/>   end
<a name="105"/>
<a name="106"/>   #
<a name="107"/>   # Helper to get the specified encoding, or the standard default.
<a name="108"/>   # 
<a name="109"/>   private get_actual_content_transfer_encoding()
<a name="110"/>      if has_header("Content-Transfer-Encoding") then
<a name="111"/>         return get_content_transfer_encoding()
<a name="112"/>      else
<a name="113"/>         return "7bit"
<a name="114"/>   end
<a name="115"/>
<a name="116"/>   #
<a name="117"/>   # Helper to get the specified content type, or the standard default.
<a name="118"/>   # 
<a name="119"/>   private get_actual_content_type()
<a name="120"/>      if has_header("Content-Type") then
<a name="121"/>         return get_content_type()
<a name="122"/>      else
<a name="123"/>         return ContentType.parse("text/plain")
<a name="124"/>   end
<a name="125"/>
<a name="126"/>   #
<a name="127"/>   # Helper to get the appropriate encoding handler
<a name="128"/>   # 
<a name="129"/>   private get_encoding_handler()
<a name="130"/>      local enc, e
<a name="131"/>      enc := get_actual_content_transfer_encoding()
<a name="132"/>      every e := !EncodingHandler.ENCODING_HANDLERS do {
<a name="133"/>         if e.can_handle(enc) then
<a name="134"/>            return e
<a name="135"/>      }
<a name="136"/>      return error("Unknown or unhandled encoding")
<a name="137"/>   end
<a name="138"/>
<a name="139"/>   #
<a name="140"/>   # Helper to get the appropriate type handler
<a name="141"/>   #
<a name="142"/>   private get_type_handler()
<a name="143"/>      local ct, e
<a name="144"/>      ct := get_actual_content_type() | fail
<a name="145"/>      every e := !TypeHandler.TYPE_HANDLERS do {
<a name="146"/>         if e.can_handle(ct) then
<a name="147"/>            return e
<a name="148"/>      }
<a name="149"/>      return error("Unknown or unhandled content type")
<a name="150"/>   end
<a name="151"/>
<a name="152"/>   #
<a name="153"/>   # Return a string representation of the message in RFC822 format.
<a name="154"/>   # 
<a name="155"/>   public to_rfc822()
<a name="156"/>      local rs
<a name="157"/>      return use {
<a name="158"/>         rs := RamStream(),
<a name="159"/>         to_rfc822_stream(rs) &amp; rs.str()
<a name="160"/>      }
<a name="161"/>   end
<a name="162"/>
<a name="163"/>   #
<a name="164"/>   # Output the message in RFC822 format to the given stream.
<a name="165"/>   #
<a name="166"/>   public to_rfc822_stream(f)
<a name="167"/>      local h, t
<a name="168"/>      every h := gen_header_entries() do {
<a name="169"/>         every t := !h.val do
<a name="170"/>            f.writes(fold(h.key || ": " || t), "\r\n") | fail
<a name="171"/>      }
<a name="172"/>      f.writes("\r\n", content) | fail
<a name="173"/>      link
<a name="174"/>   end
<a name="175"/>
<a name="176"/>   #
<a name="177"/>   # Fold a line into several CRLF lines of &lt;= 78 chars
<a name="178"/>   # 
<a name="179"/>   public static fold(s)
<a name="180"/>      local res, l, t
<a name="181"/>
<a name="182"/>      # Drop trailing w/s
<a name="183"/>      while any(' \t', s[-1]) do
<a name="184"/>         s[-1] := ""
<a name="185"/>
<a name="186"/>      # Check for simple quick case
<a name="187"/>      if *s &lt;= 78 then
<a name="188"/>         return s
<a name="189"/>
<a name="190"/>      res := ""
<a name="191"/>      # l is the current line
<a name="192"/>      l := ""
<a name="193"/>      s ? repeat {
<a name="194"/>         #
<a name="195"/>         # Get a block of text being w/s followed by non-ws eg
<a name="196"/>         #             "   here"
<a name="197"/>         #
<a name="198"/>         t := tab(many(' \t')) | ""
<a name="199"/>         t ||:= tab(upto(' \t') | 0)
<a name="200"/>         if *l + *t &gt; 78 then {
<a name="201"/>            # Too big, so start a new line.
<a name="202"/>            res := fold1(res, l)
<a name="203"/>            l := t
<a name="204"/>         } else {
<a name="205"/>            # Not too big, so continue this line.
<a name="206"/>            l ||:= t
<a name="207"/>         }
<a name="208"/>         if pos(0) then {
<a name="209"/>            # Add any remainder.
<a name="210"/>            return fold1(res, l)
<a name="211"/>         }
<a name="212"/>      }
<a name="213"/>   end
<a name="214"/>
<a name="215"/>   #
<a name="216"/>   # 
<a name="217"/>   private static fold1(res, l)
<a name="218"/>      if *l &gt; 0 then {
<a name="219"/>         if *res &gt; 0 then {
<a name="220"/>            res ||:= "\r\n"
<a name="221"/>         }
<a name="222"/>         res ||:= l
<a name="223"/>      }
<a name="224"/>      return res
<a name="225"/>   end
<a name="226"/>
<a name="227"/>   #
<a name="228"/>   # Debug output function
<a name="229"/>   #
<a name="230"/>   public show_message()
<a name="231"/>      show_headers()
<a name="232"/>      write()
<a name="233"/>      write(content)
<a name="234"/>   end
<a name="235"/>
<a name="236"/>   #
<a name="237"/>   # Parse the given raw data into a Message.
<a name="238"/>   #
<a name="239"/>   public static parse(data)
<a name="240"/>      local s, m
<a name="241"/>      m := Message()
<a name="242"/>      data ? {
<a name="243"/>         while s := tab(find("\r\n")) do {
<a name="244"/>            move(2)
<a name="245"/>            if *s = 0 then {
<a name="246"/>               m.content := tab(0)
<a name="247"/>               return m
<a name="248"/>            }
<a name="249"/>            while any(' \t') do {
<a name="250"/>               s ||:= tab(find("\r\n")) | return error("Unexpected end of message")
<a name="251"/>               move(2)
<a name="252"/>            }
<a name="253"/>            RFC822Parser().parse_field(s, m) | fail
<a name="254"/>         }
<a name="255"/>         return error("Unexpected end of message")
<a name="256"/>      }
<a name="257"/>   end
<a name="258"/>
<a name="259"/>   #
<a name="260"/>   # Turn the given parameter into a comma-separated list of addresses.  The
<a name="261"/>   # param is either an `Address` or a list of `Address`es.
<a name="262"/>   # 
<a name="263"/>   private catenate_addresses(a)
<a name="264"/>      return if type(a) == "list" then
<a name="265"/>         String{ (!a).to_rfc822(), ", " }
<a name="266"/>      else
<a name="267"/>         return a.to_rfc822()
<a name="268"/>   end
<a name="269"/>
<a name="270"/>   # 
<a name="271"/>   private header_error(h, s)
<a name="272"/>      return error("Error parsing " || h || " header: " || image(s) || ": " || &amp;why)
<a name="273"/>   end
<a name="274"/>
<a name="275"/>   #
<a name="276"/>   # Get the "Date" header as a `Time` object.
<a name="277"/>   # :Fails :
<a name="278"/>   # :  if the "Date" header is absent or cannot be parsed.
<a name="279"/>   # :Returns :
<a name="280"/>   # :  a `Time` instance
<a name="281"/>   #
<a name="282"/>   public get_date()
<a name="283"/>      local s
<a name="284"/>      s := get_first_header("Date") | return error("Missing header: Date")
<a name="285"/>      return RFC822Parser().parse_date_time(s) | header_error("Date", s)
<a name="286"/>   end
<a name="287"/>
<a name="288"/>   #
<a name="289"/>   # Set the "Date" header from the given `Time` object.
<a name="290"/>   # :Parameters :
<a name="291"/>   # :  `t` - the `Time` from which to set the date field.
<a name="292"/>   #
<a name="293"/>   public set_date(t)
<a name="294"/>      return set_header("Date", t.to_rfc822())
<a name="295"/>   end
<a name="296"/>
<a name="297"/>   #
<a name="298"/>   # Get the "To" header(s) as a list of `Address` instances.
<a name="299"/>   # :Returns :
<a name="300"/>   # :  a list of `Address` instances
<a name="301"/>   # :Fails :
<a name="302"/>   # :  if the "To" header is absent or cannot be parsed as a 
<a name="303"/>   #       list of `Address`es
<a name="304"/>   #
<a name="305"/>   public get_to()
<a name="306"/>      local s
<a name="307"/>      s := get_catenated_headers("To") | return error("Missing header: To")
<a name="308"/>      return RFC822Parser().parse_address_list(s) | header_error("To", s)
<a name="309"/>   end
<a name="310"/>
<a name="311"/>   #
<a name="312"/>   # Set the "To" header from the given parameter, which may be either
<a name="313"/>   # a single `Address`, or a list of several `Address`es.  To add further "To"
<a name="314"/>   # headers, use `add_to`.
<a name="315"/>   # :Parameters :
<a name="316"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="317"/>   #
<a name="318"/>   public set_to(a)
<a name="319"/>      return set_header("To", catenate_addresses(a))
<a name="320"/>   end
<a name="321"/>
<a name="322"/>   #
<a name="323"/>   # Add a "To" header from the given parameter, which may be either
<a name="324"/>   # a single `Address`, or a list of several `Address`es.
<a name="325"/>   # :Parameters :
<a name="326"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="327"/>   #
<a name="328"/>   public add_to(a)
<a name="329"/>      return add_header("To", catenate_addresses(a))
<a name="330"/>   end
<a name="331"/>
<a name="332"/>   #
<a name="333"/>   # Get the "Reply-To" header(s) as a list of `Address` instances.
<a name="334"/>   # :Returns :
<a name="335"/>   # :  a list of `Address` instances
<a name="336"/>   # :Fails :
<a name="337"/>   # :  if the "Reply-To" header is absent or cannot be parsed as a 
<a name="338"/>   #       list of `Address`es
<a name="339"/>   #
<a name="340"/>   public get_reply_to()
<a name="341"/>      local s
<a name="342"/>      s := get_catenated_headers("Reply-To") | return error("Missing header: Reply-To")
<a name="343"/>      return RFC822Parser().parse_address_list(s, &amp;yes) | header_error("Reply-To", s)
<a name="344"/>   end
<a name="345"/>
<a name="346"/>   #
<a name="347"/>   # Set the "Reply-To" header from the given parameter, which may be either
<a name="348"/>   # a single `Address`, or a list of several `Address`es.  To add further "Reply-To"
<a name="349"/>   # headers, use `add_reply_to`.
<a name="350"/>   # :Parameters :
<a name="351"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="352"/>   #
<a name="353"/>   public set_reply_to(a)
<a name="354"/>      return set_header("Reply-To", catenate_addresses(a))
<a name="355"/>   end
<a name="356"/>
<a name="357"/>   #
<a name="358"/>   # Add a "Reply-To" header from the given parameter, which may be either
<a name="359"/>   # a single `Address`, or a list of several `Address`es.
<a name="360"/>   # :Parameters :
<a name="361"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="362"/>   #
<a name="363"/>   public add_reply_to(a)
<a name="364"/>      return add_header("Reply-To", catenate_addresses(a))
<a name="365"/>   end
<a name="366"/>
<a name="367"/>   #
<a name="368"/>   # Get the "Resent-To" header(s) as a list of `Address` instances.
<a name="369"/>   # :Returns :
<a name="370"/>   # :  a list of `Address` instances
<a name="371"/>   # :Fails :
<a name="372"/>   # :  if the "Resent-To" header is absent or cannot be parsed as a 
<a name="373"/>   #       list of `Address`es
<a name="374"/>   #
<a name="375"/>   public get_resent_to()
<a name="376"/>      local s
<a name="377"/>      s := get_catenated_headers("Resent-To") | return error("Missing header: Resent-To")
<a name="378"/>      return RFC822Parser().parse_address_list(s) | header_error("Resent-To", s)
<a name="379"/>   end
<a name="380"/>
<a name="381"/>   #
<a name="382"/>   # Set the "Resent-To" header from the given parameter, which may be either
<a name="383"/>   # a single `Address`, or a list of several `Address`es.  To add further "Resent-To"
<a name="384"/>   # headers, use `add_resent_to`.
<a name="385"/>   # :Parameters :
<a name="386"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="387"/>   #
<a name="388"/>   public set_resent_to(a)
<a name="389"/>      return set_header("Resent-To", catenate_addresses(a))
<a name="390"/>   end
<a name="391"/>
<a name="392"/>   #
<a name="393"/>   # Add a "Resent-To" header from the given parameter, which may be either
<a name="394"/>   # a single `Address`, or a list of several `Address`es.
<a name="395"/>   # :Parameters :
<a name="396"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="397"/>   #
<a name="398"/>   public add_resent_to(a)
<a name="399"/>      return add_header("Resent-To", catenate_addresses(a))
<a name="400"/>   end
<a name="401"/>
<a name="402"/>   #
<a name="403"/>   # Get the "cc" header(s) as a list of `Address` instances.
<a name="404"/>   # :Returns :
<a name="405"/>   # :  a list of `Address` instances
<a name="406"/>   # :Fails :
<a name="407"/>   # :  if the "bcc" header is absent or cannot be parsed as a 
<a name="408"/>   #       list of `Address`es
<a name="409"/>   #
<a name="410"/>   public get_cc()
<a name="411"/>      local s
<a name="412"/>      s := get_catenated_headers("cc") | return error("Missing header: cc")
<a name="413"/>      return RFC822Parser().parse_address_list(s) | header_error("cc", s)
<a name="414"/>   end
<a name="415"/>
<a name="416"/>   #
<a name="417"/>   # Set the "cc" header from the given parameter, which may be either
<a name="418"/>   # a single `Address`, or a list of several `Address`es.  To add further "cc"
<a name="419"/>   # headers, use `add_cc`.
<a name="420"/>   # :Parameters :
<a name="421"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="422"/>   #
<a name="423"/>   public set_cc(a)
<a name="424"/>      return set_header("cc", catenate_addresses(a))
<a name="425"/>   end
<a name="426"/>
<a name="427"/>   #
<a name="428"/>   # Add a "cc" header from the given parameter, which may be either
<a name="429"/>   # a single `Address`, or a list of several `Address`es.
<a name="430"/>   # :Parameters :
<a name="431"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="432"/>   #
<a name="433"/>   public add_cc(a)
<a name="434"/>      return add_header("cc", catenate_addresses(a))
<a name="435"/>   end
<a name="436"/>
<a name="437"/>   #
<a name="438"/>   # Get the "Resent-cc" header(s) as a list of `Address` instances.
<a name="439"/>   # :Returns :
<a name="440"/>   # :  a list of `Address` instances
<a name="441"/>   # :Fails :
<a name="442"/>   # :  if the "Resent-cc" header is absent or cannot be parsed as a 
<a name="443"/>   #       list of `Address`es
<a name="444"/>   #
<a name="445"/>   public get_resent_cc()
<a name="446"/>      local s
<a name="447"/>      s := get_catenated_headers("Resent-cc") | return error("Missing header: Resent-cc")
<a name="448"/>      return RFC822Parser().parse_address_list(s) | header_error("Resent-cc", s)
<a name="449"/>   end
<a name="450"/>
<a name="451"/>   #
<a name="452"/>   # Set the "Resent-cc" header from the given parameter, which may be either
<a name="453"/>   # a single `Address`, or a list of several `Address`es.  To add further "Resent-cc"
<a name="454"/>   # headers, use `add_resent_cc`.
<a name="455"/>   # :Parameters :
<a name="456"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="457"/>   #
<a name="458"/>   public set_resent_cc(a)
<a name="459"/>      return set_header("Resent-cc", catenate_addresses(a))
<a name="460"/>   end
<a name="461"/>
<a name="462"/>   #
<a name="463"/>   # Add a "Resent-cc" header from the given parameter, which may be either
<a name="464"/>   # a single `Address`, or a list of several `Address`es.
<a name="465"/>   # :Parameters :
<a name="466"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="467"/>   #
<a name="468"/>   public add_resent_cc(a)
<a name="469"/>      return add_header("Resent-cc", catenate_addresses(a))
<a name="470"/>   end
<a name="471"/>
<a name="472"/>   #
<a name="473"/>   # Get the "bcc" header(s) as a list of `Address` instances.
<a name="474"/>   # :Returns :
<a name="475"/>   # :  a list of `Address` instances
<a name="476"/>   # :Fails :
<a name="477"/>   # :  if the "bcc" header is absent or cannot be parsed as a 
<a name="478"/>   #       list of `Address`es
<a name="479"/>   #
<a name="480"/>   public get_bcc()
<a name="481"/>      local s
<a name="482"/>      s := get_catenated_headers("bcc") | return error("Missing header: bcc")
<a name="483"/>      return RFC822Parser().parse_address_list(s, &amp;yes) | header_error("bcc", s)
<a name="484"/>   end
<a name="485"/>
<a name="486"/>   #
<a name="487"/>   # Set the "bcc" header from the given parameter, which may be either
<a name="488"/>   # a single `Address`, or a list of several `Address`es.  To add further "bcc"
<a name="489"/>   # headers, use `add_bcc`.
<a name="490"/>   # :Parameters :
<a name="491"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="492"/>   #
<a name="493"/>   public set_bcc(a)
<a name="494"/>      return set_header("bcc", catenate_addresses(a))
<a name="495"/>   end
<a name="496"/>
<a name="497"/>   #
<a name="498"/>   # Add a "bcc" header from the given parameter, which may be either
<a name="499"/>   # a single `Address`, or a list of several `Address`es.
<a name="500"/>   # :Parameters :
<a name="501"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="502"/>   #
<a name="503"/>   public add_bcc(a)
<a name="504"/>      return add_header("bcc", catenate_addresses(a))
<a name="505"/>   end
<a name="506"/>
<a name="507"/>   #
<a name="508"/>   # Get the "Resent-bcc" header(s) as a list of `Address` instances.
<a name="509"/>   # :Returns :
<a name="510"/>   # :  a list of `Address` instances
<a name="511"/>   # :Fails :
<a name="512"/>   # :  if the "Reset-bcc" header is absent or cannot be parsed as a 
<a name="513"/>   #       list of `Address`es
<a name="514"/>   #
<a name="515"/>   public get_resent_bcc()
<a name="516"/>      local s
<a name="517"/>      s := get_catenated_headers("Resent-bcc") | return error("Missing header: Resent-bcc")
<a name="518"/>      return RFC822Parser().parse_address_list(s, &amp;yes) | header_error("Resent-bcc", s)
<a name="519"/>   end
<a name="520"/>
<a name="521"/>   #
<a name="522"/>   # Set the "Resent-bcc" header from the given parameter, which may be either
<a name="523"/>   # a single `Address`, or a list of several `Address`es.  To add further "Resent-bcc"
<a name="524"/>   # headers, use `add_resent_bcc`.
<a name="525"/>   # :Parameters :
<a name="526"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="527"/>   #
<a name="528"/>   public set_resent_bcc(a)
<a name="529"/>      return set_header("Resent-bcc", catenate_addresses(a))
<a name="530"/>   end
<a name="531"/>
<a name="532"/>   #
<a name="533"/>   # Add a "Resent-bcc" header from the given parameter, which may be either
<a name="534"/>   # a single `Address`, or a list of several `Address`es.
<a name="535"/>   # :Parameters :
<a name="536"/>   # :  `a` - an `Address` or a list of `Address`es.
<a name="537"/>   #
<a name="538"/>   public add_resent_bcc(a)
<a name="539"/>      return add_header("Resent-bcc", catenate_addresses(a))
<a name="540"/>   end
<a name="541"/>
<a name="542"/>   #
<a name="543"/>   # Get the "From" header(s) as a list of `Mailbox` instances.
<a name="544"/>   # :Returns :
<a name="545"/>   # :  a list of `Mailbox` instances
<a name="546"/>   # :Fails :
<a name="547"/>   # :  if the "From" header is absent or cannot be parsed as a 
<a name="548"/>   #       list of `Mailbox`es
<a name="549"/>   #
<a name="550"/>   public get_from()
<a name="551"/>      local s
<a name="552"/>      s := get_catenated_headers("From") | return error("Missing header: From")
<a name="553"/>      return RFC822Parser().parse_mailbox_list(s) | header_error("From", s)
<a name="554"/>   end
<a name="555"/>
<a name="556"/>   #
<a name="557"/>   # Set the "From" header from the given parameter, which may be either
<a name="558"/>   # a single `Mailbox`, or a list of several `Mailbox`es.  To add further "From"
<a name="559"/>   # headers, use `add_from`.
<a name="560"/>   # :Parameters :
<a name="561"/>   # :  `a` - an `Mailbox` or a list of `Mailbox`es.
<a name="562"/>   #
<a name="563"/>   public set_from(m)
<a name="564"/>      return set_header("From", catenate_addresses(m))
<a name="565"/>   end
<a name="566"/>
<a name="567"/>   #
<a name="568"/>   # Add a "From" header from the given parameter, which may be either
<a name="569"/>   # a single `Mailbox`, or a list of several `Mailbox`es.
<a name="570"/>   # :Parameters :
<a name="571"/>   # :  `a` - an `Mailbox` or a list of `Mailbox`es.
<a name="572"/>   #
<a name="573"/>   public add_from(m)
<a name="574"/>      return add_header("From", catenate_addresses(m))
<a name="575"/>   end
<a name="576"/>
<a name="577"/>   #
<a name="578"/>   # Get the "Sender" header as a `Mailbox` instance.
<a name="579"/>   # :Returns :
<a name="580"/>   # :  a `Mailbox`
<a name="581"/>   # :Fails :
<a name="582"/>   # :  if the "Sender" header is absent or cannot be parsed as a 
<a name="583"/>   #       `Mailbox`
<a name="584"/>   #
<a name="585"/>   public get_sender()
<a name="586"/>      local s
<a name="587"/>      s := get_first_header("Sender") | return error("Missing header: Sender")
<a name="588"/>      return RFC822Parser().parse_mailbox(s) | header_error("Sender", s)
<a name="589"/>   end
<a name="590"/>
<a name="591"/>   #
<a name="592"/>   # Set the "Sender" header from the given `Mailbox` instance.
<a name="593"/>   # :Parameters :
<a name="594"/>   # :  `m` - a `Mailbox`
<a name="595"/>   #
<a name="596"/>   public set_sender(m)
<a name="597"/>      return set_header("Sender", m.to_rfc822())
<a name="598"/>   end
<a name="599"/>
<a name="600"/>   #
<a name="601"/>   # Add a "Resent-From" header from the given parameter, which may be either
<a name="602"/>   # a single `Mailbox`, or a list of several `Mailbox`es.
<a name="603"/>   # :Parameters :
<a name="604"/>   # :  `a` - an `Mailbox` or a list of `Mailbox`es.
<a name="605"/>   #
<a name="606"/>   public get_resent_from()
<a name="607"/>      local s
<a name="608"/>      s := get_catenated_headers("Resent-From") | return error("Missing header: Resent-From")
<a name="609"/>      return RFC822Parser().parse_mailbox_list(s) | header_error("Resent-From", s)
<a name="610"/>   end
<a name="611"/>
<a name="612"/>   #
<a name="613"/>   # Set the "Resent-From" header from the given parameter, which may be either
<a name="614"/>   # a single `Mailbox`, or a list of several `Mailbox`es.  To add further "Resent-From"
<a name="615"/>   # headers, use `add_resent_from`.
<a name="616"/>   # :Parameters :
<a name="617"/>   # :  `a` - an `Mailbox` or a list of `Mailbox`es.
<a name="618"/>   #
<a name="619"/>   public set_resent_from(m)
<a name="620"/>      return set_header("Resent-From", catenate_addresses(m))
<a name="621"/>   end
<a name="622"/>
<a name="623"/>   #
<a name="624"/>   # Add a "Resent-From" header from the given parameter, which may be either
<a name="625"/>   # a single `Mailbox`, or a list of several `Mailbox`es.
<a name="626"/>   # :Parameters :
<a name="627"/>   # :  `a` - an `Mailbox` or a list of `Mailbox`es.
<a name="628"/>   #
<a name="629"/>   public add_resent_from(m)
<a name="630"/>      return add_header("Resent-From", catenate_addresses(m))
<a name="631"/>   end
<a name="632"/>
<a name="633"/>   #
<a name="634"/>   # Get the "Resent-Sender" header as a `Mailbox` instance.
<a name="635"/>   # :Returns :
<a name="636"/>   # :  a `Mailbox`
<a name="637"/>   # :Fails :
<a name="638"/>   # :  if the "Resent-Sender" header is absent or cannot be parsed as a 
<a name="639"/>   #       `Mailbox`
<a name="640"/>   #
<a name="641"/>   public get_resent_sender()
<a name="642"/>      local s
<a name="643"/>      s := get_first_header("Resent-Sender") | return error("Missing header: Resent-Sender")
<a name="644"/>      return RFC822Parser().parse_mailbox(s) | header_error("Resent-Sender", s)
<a name="645"/>   end
<a name="646"/>
<a name="647"/>   #
<a name="648"/>   # Set the "Resent-Sender" header from the given `Mailbox` instance.
<a name="649"/>   # :Parameters :
<a name="650"/>   # :  `m` - a `Mailbox`
<a name="651"/>   #
<a name="652"/>   public set_resent_sender(m)
<a name="653"/>      return set_header("Resent-Sender", m.to_rfc822())
<a name="654"/>   end
<a name="655"/>
<a name="656"/>   #
<a name="657"/>   # Get the "Resent-Date" header as a `Time` instance.
<a name="658"/>   # :Returns :
<a name="659"/>   # :  a `Time`
<a name="660"/>   #
<a name="661"/>   public get_resent_date()
<a name="662"/>      local s
<a name="663"/>      s := get_first_header("Resent-Date") | return error("Missing header: Resent-Date")
<a name="664"/>      return RFC822Parser().parse_date_time(s) | header_error("Resent-Date", s)
<a name="665"/>   end
<a name="666"/>
<a name="667"/>   #
<a name="668"/>   # Set the "Resent-Date" header from the given `Time` instance.
<a name="669"/>   # :Parameters :
<a name="670"/>   # :  `t` - a `Time`
<a name="671"/>   #
<a name="672"/>   public set_resent_date(t)
<a name="673"/>      return set_header("Resent-Date", t.to_rfc822())
<a name="674"/>   end
<a name="675"/>
<a name="676"/>   #
<a name="677"/>   # Get the "Content-Type" header as a `ContentType` intance.
<a name="678"/>   # :Returns :
<a name="679"/>   # :  a `ContentType`
<a name="680"/>   # :Fails :
<a name="681"/>   # :  if the "Content-Type" header is absent or cannot be parsed.
<a name="682"/>   #
<a name="683"/>   public get_content_type()
<a name="684"/>      local s
<a name="685"/>      s := get_first_header("Content-Type") | return error("Missing header: Content-Type")
<a name="686"/>      return RFC822Parser().parse_content_type(s) | header_error("Content-Type", s)
<a name="687"/>   end
<a name="688"/>
<a name="689"/>   #
<a name="690"/>   # Set the "Content-Type" header from a `ContentType` instance.
<a name="691"/>   # :Parameters :
<a name="692"/>   # :  `ct` - a `ContentType`
<a name="693"/>   #
<a name="694"/>   public set_content_type(ct)
<a name="695"/>      return set_header("Content-Type", ct.to_rfc1521())
<a name="696"/>   end
<a name="697"/>
<a name="698"/>   #
<a name="699"/>   # Get the "Content-Disposition" header as a `ContentDisposition` intance.
<a name="700"/>   # :Returns :
<a name="701"/>   # :  a `ContentDisposition`
<a name="702"/>   # :Fails :
<a name="703"/>   # :  if the "Content-Disposition" header is absent or cannot be parsed.
<a name="704"/>   #
<a name="705"/>   public get_content_disposition()
<a name="706"/>      local s
<a name="707"/>      s := get_first_header("Content-Disposition") | return error("Missing header: Content-Disposition")
<a name="708"/>      return RFC822Parser().parse_content_disposition(s) | header_error("Content-Disposition", s)
<a name="709"/>   end
<a name="710"/>
<a name="711"/>   #
<a name="712"/>   # Set the "Content-Disposition" header from a `ContentDisposition` instance.
<a name="713"/>   # :Parameters :
<a name="714"/>   # :  `cd` - a `ContentDisposition`
<a name="715"/>   #
<a name="716"/>   public set_content_disposition(cd)
<a name="717"/>      return set_header("Content-Disposition", cd.to_rfc1521())
<a name="718"/>   end
<a name="719"/>
<a name="720"/>   #
<a name="721"/>   # Get the "Content-Transfer-Encoding" field, as a string, or fail if it is
<a name="722"/>   # absent or an invalid value.
<a name="723"/>   # :Returns :
<a name="724"/>   # :  a string
<a name="725"/>   #
<a name="726"/>   public get_content_transfer_encoding()
<a name="727"/>      local s
<a name="728"/>      s := get_first_header("Content-Transfer-Encoding") | return error("Missing header: Content-Transfer-Encoding")
<a name="729"/>      return RFC822Parser().parse_content_transfer_encoding(s) | header_error("Content-Transfer-Encoding", s)
<a name="730"/>   end
<a name="731"/>
<a name="732"/>   #
<a name="733"/>   # Set the "Content-Transfer-Encoding" from the given string.
<a name="734"/>   #
<a name="735"/>   public set_content_transfer_encoding(s)
<a name="736"/>      return set_header("Content-Transfer-Encoding", s)
<a name="737"/>   end
<a name="738"/>
<a name="739"/>   #
<a name="740"/>   # Set the subject to the given string.
<a name="741"/>   # :Parameters :
<a name="742"/>   # :  `s` - a string
<a name="743"/>   #
<a name="744"/>   public set_subject(s)
<a name="745"/>      return set_header("Subject", s)
<a name="746"/>   end
<a name="747"/>
<a name="748"/>   #
<a name="749"/>   # Get the subject
<a name="750"/>   #
<a name="751"/>   public get_subject()
<a name="752"/>      return get_first_header("Subject")
<a name="753"/>   end
<a name="754"/>
<a name="755"/>   public override new()
<a name="756"/>      MimeHeaders.new()
<a name="757"/>      content := ""
<a name="758"/>      return
<a name="759"/>   end
<a name="760"/>end
<a name="761"/>
<a name="762"/>#
<a name="763"/># Utility to get all the mailboxes from a list of Addresses, which will
<a name="764"/># contain either Mailboxes or Groups.
<a name="765"/>#
<a name="766"/>procedure get_all_mailboxes(l)
<a name="767"/>   return List{ (!l).gen_mailboxes() }
<a name="768"/>end
</pre></body></html>
