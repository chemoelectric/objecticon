<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>base64handler.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: base64handler.icn 8996 2021-03-24 07:27:53Z rparlett $
<a name="3"/>#
<a name="4"/>
<a name="5"/>package mail
<a name="6"/>
<a name="7"/>import lang, util(error)
<a name="8"/>
<a name="9"/>#
<a name="10"/># Handles the base64 encoding of a message
<a name="11"/>#
<a name="12"/>class Base64Handler(EncodingHandler)
<a name="13"/>   public static const
<a name="14"/>      BASE64_STRING,
<a name="15"/>      BASE64_CSET, 
<a name="16"/>      BASE64_FIRST64
<a name="17"/>
<a name="18"/>   private static init()
<a name="19"/>      BASE64_STRING := &amp;ucase || &amp;lcase || &amp;digits || "+/"
<a name="20"/>      BASE64_CSET := &amp;ucase ++ &amp;lcase ++ &amp;digits ++ '+/'
<a name="21"/>      BASE64_FIRST64 := &amp;cset[1+:64]
<a name="22"/>   end
<a name="23"/>
<a name="24"/>   public override can_handle(enc)
<a name="25"/>      succeed Text.lower(enc) == "base64"
<a name="26"/>   end
<a name="27"/>
<a name="28"/>   public override decode_data(m, data)
<a name="29"/>      local s, t, w, x, y, z, res, pad
<a name="30"/>
<a name="31"/>      # Transform the data by stripping out all non base64 encoding chars.
<a name="32"/>      t := ""
<a name="33"/>      pad := 0
<a name="34"/>      data ? {
<a name="35"/>         while tab(upto(BASE64_CSET)) do
<a name="36"/>            t ||:= tab(many(BASE64_CSET))
<a name="37"/>         while tab(upto('=')) do {
<a name="38"/>            s := tab(many('='))
<a name="39"/>            pad +:= *s
<a name="40"/>            t ||:= repl("\x00", *s)
<a name="41"/>         }
<a name="42"/>      }
<a name="43"/>
<a name="44"/>      if (pad &gt; 2) | (*t % 4 ~= 0) then 
<a name="45"/>         return error("Badly formatted Base64 data")
<a name="46"/>
<a name="47"/>      t := map(t, BASE64_STRING, BASE64_FIRST64)
<a name="48"/>
<a name="49"/>      res := ""
<a name="50"/>      t ? while ( w := ord(move(1)), x := ord(move(1)), y := ord(move(1)), z := ord(move(1)) ) do {
<a name="51"/>         res ||:= char( ior( ishift(w,2), ishift(x,-4) ) )
<a name="52"/>         res ||:= char( ior( iand(ishift(x,4),255), ishift(y,-2) ) )
<a name="53"/>         res ||:= char( ior( iand(ishift(y,6),255), z ) )
<a name="54"/>      }
<a name="55"/>
<a name="56"/>      res[0 -: pad] := ""
<a name="57"/>
<a name="58"/>      return res
<a name="59"/>   end
<a name="60"/>
<a name="61"/>   public override encode_data(m, data)
<a name="62"/>      local i, j, k, pad, res, ll
<a name="63"/>
<a name="64"/>      res := ""
<a name="65"/>      ll := 0
<a name="66"/>
<a name="67"/>      pad := (3 - (*data % 3)) % 3
<a name="68"/>
<a name="69"/>      data ||:= repl("\x00", pad)
<a name="70"/>
<a name="71"/>      data ? while (i := ord(move(1)), j := ord(move(1)), k := ord(move(1))) do {
<a name="72"/>         res ||:= BASE64_STRING[ 1 + ishift(i,-2) ]
<a name="73"/>         res ||:= BASE64_STRING[ 1 + ior( ishift(iand(i,3),4), ishift(j,-4) ) ]
<a name="74"/>         res ||:= BASE64_STRING[ 1 + ior( ishift(iand(j,15),2), ishift(k,-6) ) ]
<a name="75"/>         res ||:= BASE64_STRING[ 1 + iand(k,63) ]
<a name="76"/>         ll +:= 1
<a name="77"/>         if ll = 19 then {
<a name="78"/>            res ||:= "\r\n"
<a name="79"/>            ll := 0
<a name="80"/>         }
<a name="81"/>      }
<a name="82"/>      res[ 0 -: pad ] := repl("=", pad)
<a name="83"/>      res ||:= "\r\n"
<a name="84"/>
<a name="85"/>      return res
<a name="86"/>   end
<a name="87"/>end
</pre></body></html>
