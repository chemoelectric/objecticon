<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>exprfile.icn</title></head><body><pre>
<a name="1"/>############################################################################
<a name="2"/>#
<a name="3"/>#	File:     exprfile.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures to produce programs on the fly
<a name="6"/>#
<a name="7"/>#	Author:   Ralph E. Griswold
<a name="8"/>#
<a name="9"/>#	Date:     August 5, 1997
<a name="10"/>#
<a name="11"/>############################################################################
<a name="12"/>#
<a name="13"/>#   This file is in the public domain.
<a name="14"/>#
<a name="15"/>############################################################################
<a name="16"/>#
<a name="17"/>#	exprfile(exp, link, ...)
<a name="18"/>#			produces a pipe to a program that writes all the
<a name="19"/>#			results generated by exp.  The trailing arguments
<a name="20"/>#			name link files needed for the expression.
<a name="21"/>#
<a name="22"/>#			exprfile() closes any previous pipe it opened
<a name="23"/>#			and deletes its temporary file.  Therefore,
<a name="24"/>#			exprfile() cannot be used for multiple expression
<a name="25"/>#			pipes.
<a name="26"/>#
<a name="27"/>#			If the expression fails to compile, the global
<a name="28"/>#			expr_error is set to 1; otherwise 0.
<a name="29"/>#
<a name="30"/>#	exec_expr(expr_list, links[])
<a name="31"/>#			generates the results of executing the expression
<a name="32"/>#			contained in the lists expr_list with the specified
<a name="33"/>#			links.
<a name="34"/>#
<a name="35"/>#	plst2pstr(L)	converts the list of Icon programs lines in L to a
<a name="36"/>#			string with separating newlines.
<a name="37"/>#
<a name="38"/>#	pstr2plst(s)	converts the string of Icon program lines (separated
<a name="39"/>#			by newlines) to a list of lines.
<a name="40"/>#
<a name="41"/>#	ucode(file)	produces a ucode file from the Icon program in file.
<a name="42"/>#
<a name="43"/>############################################################################
<a name="44"/>#
<a name="45"/>#  Requires:  system(), pipes, /tmp
<a name="46"/>#
<a name="47"/>############################################################################
<a name="48"/>#
<a name="49"/>#  Links:  io
<a name="50"/>#
<a name="51"/>############################################################################
<a name="52"/>
<a name="53"/>package ipl.exprfile
<a name="54"/>
<a name="55"/>import
<a name="56"/>   io(Files, close, open, write)
<a name="57"/>
<a name="58"/>global expr_error
<a name="59"/>
<a name="60"/># pipe for Icon expression
<a name="61"/>procedure exprfile(exp, links[])	
<a name="62"/>   local output
<a name="63"/>   static name, input
<a name="64"/>
<a name="65"/>   expr_error := &amp;null
<a name="66"/>
<a name="67"/>   Files.remove(\name)			# remove former executable
<a name="68"/>   close(\input)			# and close last pipe
<a name="69"/>   if /exp then fail
<a name="70"/>
<a name="71"/>   name := Files.make_temp_filename("expr")
<a name="72"/>   output := open(name || ".icn", "w") | fail
<a name="73"/>
<a name="74"/>   write(output, "import io(write)")
<a name="75"/>   every write(output, "import ", image(!links)) 
<a name="76"/>   write(output, "procedure main(args)")
<a name="77"/>   write(output, "   every write(", exp, ")")
<a name="78"/>   write(output, "end")
<a name="79"/>
<a name="80"/>   close(output)
<a name="81"/>
<a name="82"/>   if system("oit -o " || name || " -s " || name ||
<a name="83"/>      " &gt;/dev/null 2&gt;/dev/null") ~= 0 then {
<a name="84"/>          expr_error := 1
<a name="85"/>          Files.remove(name || ".icn")
<a name="86"/>          fail
<a name="87"/>          }
<a name="88"/>
<a name="89"/>   Files.remove(name || ".icn")		# remove source code file
<a name="90"/>
<a name="91"/>   #  Return a pipe for the executable.  Error messages are discarded.
<a name="92"/>
<a name="93"/>   return input := open(name || " 2&gt;/dev/null", "pr")
<a name="94"/>   
<a name="95"/>end
<a name="96"/>
<a name="97"/># execute expression in lists
<a name="98"/>procedure exec_expr(expr_list, links[])	
<a name="99"/>
<a name="100"/>   suspend !(exprfile ! push(links, plst2pstr(expr_list)))
<a name="101"/>
<a name="102"/>end
<a name="103"/>
<a name="104"/># convert program list to string
<a name="105"/>procedure plst2pstr(L)			
<a name="106"/>   local result
<a name="107"/>
<a name="108"/>   result := ""
<a name="109"/>
<a name="110"/>   every result ||:= !L || "\n"
<a name="111"/>
<a name="112"/>   return result
<a name="113"/>
<a name="114"/>end
<a name="115"/>
<a name="116"/># convert program string to list
<a name="117"/>procedure pstr2plst(s)			
<a name="118"/>   local result
<a name="119"/>
<a name="120"/>   result := []
<a name="121"/>
<a name="122"/>   s ? {
<a name="123"/>      while put(result, tab(upto('\n'))) do
<a name="124"/>         move(1)
<a name="125"/>      pos(0) | put(result, tab(0))
<a name="126"/>      }
<a name="127"/>
<a name="128"/>   return result
<a name="129"/>
<a name="130"/>end
<a name="131"/>
<a name="132"/># create ucode file
<a name="133"/>procedure ucode(file)			
<a name="134"/>
<a name="135"/>   if system("oit -s -c " || file) ~= 0 then fail
<a name="136"/>
<a name="137"/>   return
<a name="138"/>
<a name="139"/>end
</pre></body></html>
