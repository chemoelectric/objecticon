<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>menuwithpopup.icn</title></head><body><pre>
<a name="1"/>package gui
<a name="2"/>
<a name="3"/>import graphics
<a name="4"/>
<a name="5"/># A version of `Menu` which allows for a popup menu to be shown on a
<a name="6"/># right click on one of the child items.
<a name="7"/>#
<a name="8"/>abstract class MenuWithPopup(Menu)
<a name="9"/>   public
<a name="10"/>      popup
<a name="11"/>
<a name="12"/>   # This method must be implemented to return the popup `Menu` to
<a name="13"/>   # show on a right click.  It may fail, to indicate no menu should
<a name="14"/>   # be shown for this event.
<a name="15"/>   #
<a name="16"/>   # :Parameters :
<a name="17"/>   # :  `item` - the child menu item clicked on
<a name="18"/>   # :  `ev` - the right click event.
<a name="19"/>   public abstract create_popup(item, ev)
<a name="20"/>
<a name="21"/>   public override set_which_highlight(x)
<a name="22"/>      #
<a name="23"/>      # Do nothing if already in desired state.
<a name="24"/>      #
<a name="25"/>      if (self.which_highlight === x) &amp; /self.which_open then
<a name="26"/>         link
<a name="27"/>
<a name="28"/>      (\self.which_open).hide()
<a name="29"/>      if \self.which_open === popup then {
<a name="30"/>         remove(popup)
<a name="31"/>         # Hack re handle_key_escape with popup open
<a name="32"/>         if x === popup then
<a name="33"/>            x := self.which_highlight
<a name="34"/>         self.popup := &amp;null
<a name="35"/>      }
<a name="36"/>
<a name="37"/>      # Just invalidate the bits that have changed.
<a name="38"/>      self.temp_win.invalidate((\self.which_highlight).get_label_rect())
<a name="39"/>      self.which_highlight := x
<a name="40"/>      self.temp_win.invalidate((\self.which_highlight).get_label_rect())
<a name="41"/>      self.which_open := &amp;null
<a name="42"/>      link
<a name="43"/>   end
<a name="44"/>
<a name="45"/>   public override handle_press(e)
<a name="46"/>      local m, p
<a name="47"/>
<a name="48"/>      if m := which_item(e) then {
<a name="49"/>         if e.code === Mouse.RIGHT_PRESS &amp; (p := create_popup(m, e)) then {
<a name="50"/>            # Since it has no label... otherwise in_label_region crashes out.
<a name="51"/>            p.label_x := p.label_y := p.label_w := p.label_h := 0
<a name="52"/>            set_which_highlight(m)
<a name="53"/>            self.popup := self.which_open := p
<a name="54"/>            add(p)
<a name="55"/>            p.show(e.x, e.y)
<a name="56"/>         } else if m.is_sub_menu() then {
<a name="57"/>            if m === self.which_open then
<a name="58"/>               set_which_highlight(m)
<a name="59"/>            else
<a name="60"/>               set_which_open(m)
<a name="61"/>         } else
<a name="62"/>            set_which_highlight(m)
<a name="63"/>      } else
<a name="64"/>         set_which_highlight()
<a name="65"/>   end
<a name="66"/>end
</pre></body></html>
