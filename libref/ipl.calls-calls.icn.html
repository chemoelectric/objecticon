<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>calls.icn</title></head><body><pre>
<a name="1"/>############################################################################
<a name="2"/>#
<a name="3"/>#	File:     calls.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures for calls as objects
<a name="6"/>#
<a name="7"/>#	Author:   Ralph E. Griswold
<a name="8"/>#
<a name="9"/>#	Date:     May 28, 1994
<a name="10"/>#
<a name="11"/>############################################################################
<a name="12"/>#
<a name="13"/>#   This file is in the public domain.
<a name="14"/>#
<a name="15"/>############################################################################
<a name="16"/>#
<a name="17"/>#  These procedures deal with procedure invocations that are encapulated in
<a name="18"/>#  records.
<a name="19"/>#
<a name="20"/>############################################################################
<a name="21"/>#
<a name="22"/>#  Links:  ivalue, procname
<a name="23"/>#
<a name="24"/>############################################################################
<a name="25"/>
<a name="26"/>package ipl.calls
<a name="27"/>
<a name="28"/>import
<a name="29"/>   io(read, write, writes),
<a name="30"/>   ipl.ivalue(ivalue),
<a name="31"/>   ipl.procname(procname)
<a name="32"/>
<a name="33"/>record call(proc, args)
<a name="34"/>
<a name="35"/>#
<a name="36"/>#  Invoke a procedure with a argument list from a call record.
<a name="37"/>
<a name="38"/>procedure invoke(call)
<a name="39"/>
<a name="40"/>   suspend call.proc ! call.args
<a name="41"/>
<a name="42"/>end
<a name="43"/>
<a name="44"/>
<a name="45"/>#
<a name="46"/>#  Produce a string images of a call
<a name="47"/>
<a name="48"/>procedure call_image(call)
<a name="49"/>   local args
<a name="50"/>
<a name="51"/>   args := ""
<a name="52"/>
<a name="53"/>   every args ||:= !call.args || ", "
<a name="54"/>
<a name="55"/>   return procname(call.proc) || "(" || args[1:-2] || ")"
<a name="56"/>
<a name="57"/>end
<a name="58"/>
<a name="59"/>  
<a name="60"/>#  Make a call record from a string that looks like an invocation.
<a name="61"/>#  What the arguments can be is limited to the capabilities of ivalue.
<a name="62"/>
<a name="63"/>procedure make_call(s)
<a name="64"/>   local   result
<a name="65"/>
<a name="66"/>   s ? {
<a name="67"/>      result := call(proc(tab(upto('(')))) | fail
<a name="68"/>      move(1)
<a name="69"/>      result.args := make_args(tab(-1))
<a name="70"/>      }
<a name="71"/>
<a name="72"/>   return result
<a name="73"/>
<a name="74"/>end
<a name="75"/>
<a name="76"/>#  Make an argument list from a comma-separated string
<a name="77"/>
<a name="78"/>procedure make_args(s)
<a name="79"/>   local args, arg
<a name="80"/>
<a name="81"/>   args := []
<a name="82"/>
<a name="83"/>   s ? {
<a name="84"/>      while arg := tab(upto(',') | 0) do {
<a name="85"/>         put(args, ivalue(arg)) | fail
<a name="86"/>         move(1) | break
<a name="87"/>         }
<a name="88"/>      }
<a name="89"/>
<a name="90"/>   return args
<a name="91"/>
<a name="92"/>end
<a name="93"/>
<a name="94"/>#  Produce a string of Icon code to construct a call record.
<a name="95"/>
<a name="96"/>procedure call_code(s)
<a name="97"/>   local  arg, result
<a name="98"/>
<a name="99"/>   s ? {
<a name="100"/>      result := "call(" || tab(upto('(')) || ", [" | fail
<a name="101"/>      move(1)
<a name="102"/>      while arg := tab(upto(',)')) do {
<a name="103"/>         result ||:= ivalue(arg) || ", " | fail
<a name="104"/>         move(1) | break
<a name="105"/>         }
<a name="106"/>      }
<a name="107"/>
<a name="108"/>   return result[1:-2] || "])"
<a name="109"/>
<a name="110"/>end
<a name="111"/>
<a name="112"/>#  Write a table of calls to a file.  The file format is
<a name="113"/>#
<a name="114"/>#	name=proc:arg1,arg2,arg3, ... argn,
<a name="115"/>#
<a name="116"/>#  where name is the name associated with the call, proc is the
<a name="117"/>#  procedure, and arg1, arg2, arg3, ... argn are the arguments.
<a name="118"/>#  Note the trailing comma.
<a name="119"/>
<a name="120"/>procedure write_calltable(T, p, f)
<a name="121"/>   local name
<a name="122"/>
<a name="123"/>   every name := key(T) do {
<a name="124"/>      writes(f, name, "=")
<a name="125"/>      writes(f, procname(p), ":")
<a name="126"/>      every writes(f, image(!T[name]), ",")
<a name="127"/>      }
<a name="128"/>
<a name="129"/>   write(f)
<a name="130"/>
<a name="131"/>   return
<a name="132"/>
<a name="133"/>end
<a name="134"/>   
<a name="135"/>#  read a call table file into a table
<a name="136"/>
<a name="137"/>procedure read_calltable(f)
<a name="138"/>   local T, line, p, args, name
<a name="139"/>
<a name="140"/>   T := table()
<a name="141"/>
<a name="142"/>   every line := read(f) do
<a name="143"/>      line ? {
<a name="144"/>         name := tab(upto('="')) | fail
<a name="145"/>         move(1)
<a name="146"/>         p := tab(upto(':')) | fail
<a name="147"/>         move(1)
<a name="148"/>         args := []
<a name="149"/>         while put(args, ivalue(tab(upto(',')))) do
<a name="150"/>             move(1)
<a name="151"/>         T[name] := call(proc(p), args) | fail
<a name="152"/>         }
<a name="153"/>
<a name="154"/>   return T
<a name="155"/>
<a name="156"/>end
</pre></body></html>
