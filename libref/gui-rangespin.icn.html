<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>rangespin.icn</title></head><body><pre>
<a name="1"/>#
<a name="2"/># $Id: rangespin.icn 9050 2021-04-16 21:04:25Z rparlett $
<a name="3"/>#
<a name="4"/># This file is in the public domain.
<a name="5"/>#
<a name="6"/># Author: Robert Parlett (parlett@dial.pipex.com)
<a name="7"/>#
<a name="8"/>
<a name="9"/>package gui
<a name="10"/>
<a name="11"/>import util, ipl.pdco
<a name="12"/>
<a name="13"/>#
<a name="14"/># This is a Spin for numeric values, optionally within a fixed range.
<a name="15"/>#
<a name="16"/>class RangeSpin(Spin)
<a name="17"/>   public
<a name="18"/>      lo,
<a name="19"/>      hi,
<a name="20"/>      increment_size,
<a name="21"/>      last_val
<a name="22"/>
<a name="23"/>   public override create_view()
<a name="24"/>      return SpinTextField()
<a name="25"/>   end
<a name="26"/>
<a name="27"/>   public override initially()
<a name="28"/>      local f
<a name="29"/>      f := &amp;digits
<a name="30"/>      if type(lo | hi | increment_size | last_val) == "real" then
<a name="31"/>         f ++:= '.'
<a name="32"/>      if /lo | /hi | (lo &lt; 0) then
<a name="33"/>         f ++:= '\-'
<a name="34"/>      view.set_filter(f)
<a name="35"/>      Spin.initially()
<a name="36"/>   end
<a name="37"/>
<a name="38"/>   public override do_increment(ev)
<a name="39"/>      assign_value(last_val + self.increment_size, ev, &amp;yes)
<a name="40"/>   end
<a name="41"/>
<a name="42"/>   public override do_decrement(ev)
<a name="43"/>      assign_value(last_val - self.increment_size, ev, &amp;yes)
<a name="44"/>   end
<a name="45"/>
<a name="46"/>   #
<a name="47"/>   # Set the range of allowed values.  The values may
<a name="48"/>   # be integer or real.
<a name="49"/>   #
<a name="50"/>   # :Parameters :
<a name="51"/>   # :  `lo` - The lower bound
<a name="52"/>   # :  `hi` - The upper bound
<a name="53"/>   #
<a name="54"/>   public set_range(lo, hi)
<a name="55"/>      self.lo := /lo | need_numeric(lo)
<a name="56"/>      self.hi := /hi | need_numeric(hi)
<a name="57"/>      link
<a name="58"/>   end
<a name="59"/>
<a name="60"/>   #
<a name="61"/>   # Set the value
<a name="62"/>   #
<a name="63"/>   public set_value(x)
<a name="64"/>      x := need_numeric(x)
<a name="65"/>      x &lt;:= \self.lo
<a name="66"/>      x &gt;:= \self.hi
<a name="67"/>      view.set_contents(x)
<a name="68"/>      if is_live() then
<a name="69"/>         view.remove_wattrib(WAttrib.FG).reset()
<a name="70"/>      last_val := x
<a name="71"/>      link
<a name="72"/>   end
<a name="73"/>
<a name="74"/>   #
<a name="75"/>   # Set the value, firing events
<a name="76"/>   #
<a name="77"/>   public assign_value(x, ev, coalesce)
<a name="78"/>      x := need_numeric(x)
<a name="79"/>      x &lt;:= \self.lo
<a name="80"/>      x &gt;:= \self.hi
<a name="81"/>      view.assign_contents(x,, ev, coalesce)
<a name="82"/>      link
<a name="83"/>   end
<a name="84"/>
<a name="85"/>   #
<a name="86"/>   # Set the increment, ie the amount moved up/down by the buttons.
<a name="87"/>   #
<a name="88"/>   public set_increment_size(x)
<a name="89"/>      self.increment_size := need_numeric(x)
<a name="90"/>      link
<a name="91"/>   end
<a name="92"/>
<a name="93"/>   public on_textfield(ev, src, type)
<a name="94"/>      if last_val := get_value() then
<a name="95"/>         view.remove_wattrib(WAttrib.FG).reset()
<a name="96"/>      else
<a name="97"/>         view.set_fg(Style.ERROR_COLOR).reset()
<a name="98"/>      # Fire the event with self as source.
<a name="99"/>      fire(type, ev)
<a name="100"/>   end
<a name="101"/>
<a name="102"/>   #
<a name="103"/>   # Return the value, or fail if the value is not presently a valid
<a name="104"/>   # numeric value in the required range.
<a name="105"/>   #
<a name="106"/>   public get_value()
<a name="107"/>      local v
<a name="108"/>      v := numeric(view.get_contents()) | fail
<a name="109"/>      if (v &lt; \self.lo) | (v &gt; \self.hi) then
<a name="110"/>         fail
<a name="111"/>      return v
<a name="112"/>   end
<a name="113"/>
<a name="114"/>   public override get_default_width()
<a name="115"/>      return border.get_total_width() +
<a name="116"/>         up.get_preferred_width() +
<a name="117"/>         # Bit difficult if we don't have a maximum...
<a name="118"/>         MaxNN{ self.cbwin.text_width((view.contents | \self.lo | \self.hi) || " ") } +
<a name="119"/>         view.border.get_total_width()
<a name="120"/>   end
<a name="121"/>
<a name="122"/>   public override new()
<a name="123"/>      Spin.new()
<a name="124"/>      self.increment_size := 1
<a name="125"/>      every view.connect(self.on_textfield, Event.CONTENT_CHANGED | Event.ACTION)
<a name="126"/>      return
<a name="127"/>   end
<a name="128"/>end
</pre></body></html>
