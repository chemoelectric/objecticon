<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>messagelabel.icn</title></head><body><pre>
<a name="1"/>package gui
<a name="2"/>
<a name="3"/>import graphics(Selection), lang(Class)
<a name="4"/>
<a name="5"/>#
<a name="6"/># Useful class for displaying a status/error message
<a name="7"/>#
<a name="8"/>class MessageLabel(Label)
<a name="9"/>   private
<a name="10"/>      want_s,
<a name="11"/>      want_n,
<a name="12"/>      keep,
<a name="13"/>      message,
<a name="14"/>      message_tt
<a name="15"/>
<a name="16"/>   private set_impl(s)
<a name="17"/>      local p
<a name="18"/>      if message ~=== s then {
<a name="19"/>         p := if /s then TextPaint("") else AbbreviatedTextPaint(s)
<a name="20"/>         message := s
<a name="21"/>         message_tt := &amp;null
<a name="22"/>         set_paint(p)
<a name="23"/>      }
<a name="24"/>   end
<a name="25"/>
<a name="26"/>   #
<a name="27"/>   # Set the label to the given string `s`.  If `s` is &amp;null, then the
<a name="28"/>   # label is cleared.  If `n` is given then the label will remain
<a name="29"/>   # unchanged for at least `n` milliseconds regardless of future
<a name="30"/>   # calls to `set`.  This can be used for particularly important
<a name="31"/>   # messages.
<a name="32"/>   #
<a name="33"/>   public set(s, n)
<a name="34"/>      local t
<a name="35"/>      if /keep then {
<a name="36"/>         set_impl(s)
<a name="37"/>         if \n then {
<a name="38"/>            keep := &amp;yes
<a name="39"/>            t := Dispatcher.new_task{{
<a name="40"/>               repeat {
<a name="41"/>                  t.sleep(n)
<a name="42"/>                  set_impl(\want_s)
<a name="43"/>                  n := want_n
<a name="44"/>                  want_s := want_n := &amp;null
<a name="45"/>                  if /n then
<a name="46"/>                     break
<a name="47"/>               }
<a name="48"/>               keep := &amp;null
<a name="49"/>               t.revert()
<a name="50"/>            }}
<a name="51"/>            t.start()
<a name="52"/>         }
<a name="53"/>      } else if /want_n | \n then {        # A message with a time overrides any earlier
<a name="54"/>          want_s := s                      # one.
<a name="55"/>          want_n := n
<a name="56"/>      }
<a name="57"/>      link
<a name="58"/>   end
<a name="59"/>
<a name="60"/>   public override get_tooltip()
<a name="61"/>      if w - border.get_total_width() &lt; cbwin.text_width(\message) then {
<a name="62"/>         /message_tt := split_string(cbwin,
<a name="63"/>                                     message,
<a name="64"/>                                     Style.TOOLTIP_FONT,
<a name="65"/>                                     scale(500))
<a name="66"/>         return message_tt
<a name="67"/>      }
<a name="68"/>   end
<a name="69"/>
<a name="70"/>   private on_copy()
<a name="71"/>      parent_dialog.own_selection(Selection.CLIPBOARD,
<a name="72"/>                                  StaticTextSelectionOwner(\message))
<a name="73"/>   end
<a name="74"/>
<a name="75"/>   private on_rpress(ev)
<a name="76"/>      local pm, m
<a name="77"/>      \message | fail
<a name="78"/>      # Ensure the copy icon is in the cache.
<a name="79"/>      Class.ensure_initialized(TextContextMenu)
<a name="80"/>      m := Menu()
<a name="81"/>      m.add(TextMenuItem().
<a name="82"/>               set_label("Copy").
<a name="83"/>               set_paint_left(ImagePaint().set_cache("txt.copy")).
<a name="84"/>               connect(on_copy, Event.ACTION))
<a name="85"/>      pm := PopupMenu()
<a name="86"/>      pm.popup(self, m, ev.x, ev.y)
<a name="87"/>   end
<a name="88"/>
<a name="89"/>   public override new()
<a name="90"/>      Label.new()
<a name="91"/>      set_label("")
<a name="92"/>      set_fg(Style.INFO_COLOR)
<a name="93"/>      connect(on_rpress, Event.MOUSE_RIGHT_PRESS)
<a name="94"/>      return
<a name="95"/>   end
<a name="96"/>end
</pre></body></html>
