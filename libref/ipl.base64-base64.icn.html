<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>base64.icn</title></head><body><pre>
<a name="1"/>#############################################################################
<a name="2"/>#
<a name="3"/>#	File:     base64.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures for base64 encodings for MIME (RFC 2045)
<a name="6"/>#
<a name="7"/>#	Author:   David A. Gamey
<a name="8"/>#
<a name="9"/>#	Date:     May 2, 2001
<a name="10"/>#
<a name="11"/>#############################################################################
<a name="12"/>#
<a name="13"/>#   This file is in the public domain.
<a name="14"/>#
<a name="15"/>#############################################################################
<a name="16"/>#
<a name="17"/>#     Descriptions:
<a name="18"/>#
<a name="19"/>#     base64encode( s1 ) : s2
<a name="20"/>#
<a name="21"/>#        returns the base64 encoding of a string s1
<a name="22"/>#
<a name="23"/>#     base64decode( s1 ) : s2
<a name="24"/>#
<a name="25"/>#        returns the base64 decoding of a string s1
<a name="26"/>#        fails if s1 isn't base64 encoded
<a name="27"/>#
<a name="28"/>#     references:  MIME encoding Internet RFC 2045
<a name="29"/>#
<a name="30"/>#############################################################################
<a name="31"/>
<a name="32"/>package ipl.base64
<a name="33"/>
<a name="34"/>import util(error,need_string)
<a name="35"/>
<a name="36"/># encode a string into base 64 (MIME)
<a name="37"/>procedure base64encode(s)   
<a name="38"/>   local  pad, t, i, j, k
<a name="39"/>   static b64
<a name="40"/>   initial b64 := &amp;ucase || &amp;lcase || &amp;digits || "+/"
<a name="41"/>
<a name="42"/>   s := need_string(s)
<a name="43"/>   i := (3 - (*s % 3)) % 3
<a name="44"/>   s ||:= repl("\x00",i)
<a name="45"/>   pad := repl("=",i)
<a name="46"/>
<a name="47"/>   t := ""
<a name="48"/>   s ? while ( i := ord(move(1)), j := ord(move(1)), k := ord(move(1)) ) do {
<a name="49"/>      t ||:= b64[ 1 + ishift(i,-2) ]
<a name="50"/>      t ||:= b64[ 1 + ior( ishift(iand(i,3),4), ishift(j,-4) ) ]
<a name="51"/>      t ||:= b64[ 1 + ior( ishift(iand(j,15),2), ishift(k,-6) ) ]
<a name="52"/>      t ||:= b64[ 1 + iand(k,63) ]
<a name="53"/>      }
<a name="54"/>   t[ 0 -: *pad ] := pad
<a name="55"/>
<a name="56"/>   return t
<a name="57"/>end
<a name="58"/>
<a name="59"/># decode a string from base 64 (MIME)
<a name="60"/>procedure base64decode(s)  
<a name="61"/>   local t, w, x, y, z, pad
<a name="62"/>   static b64, c64, n64
<a name="63"/>   initial {
<a name="64"/>      b64 := &amp;ucase || &amp;lcase || &amp;digits || "+/"
<a name="65"/>      c64 := cset(b64)
<a name="66"/>      n64 := &amp;cset[1+:64]
<a name="67"/>      }
<a name="68"/>
<a name="69"/>   s := need_string(s)
<a name="70"/>
<a name="71"/>   s ? {
<a name="72"/>      tab(many(c64))
<a name="73"/>      pad := *tab(many('=')) | 0
<a name="74"/>      pos(0) | return error("Extraneous Base64 chars in data")
<a name="75"/>   }
<a name="76"/>
<a name="77"/>   if (pad &gt; 2) | (*s % 4  ~= 0) then
<a name="78"/>      return error("Badly formatted Base64 data")
<a name="79"/>
<a name="80"/>   s[0 -: pad] := repl("\x00", pad)
<a name="81"/>   s := map(s,b64,n64)
<a name="82"/>
<a name="83"/>   t := ""
<a name="84"/>   s ? while ( w := ord(move(1)), x := ord(move(1)),
<a name="85"/>               y := ord(move(1)), z := ord(move(1)) ) do {
<a name="86"/>      t ||:= char( ior( ishift(w,2), ishift(x,-4) ) )
<a name="87"/>      t ||:= char( ior( iand(ishift(x,4),255), ishift(y,-2) ) )
<a name="88"/>      t ||:= char( ior( iand(ishift(y,6),255), z ) )
<a name="89"/>      }
<a name="90"/>
<a name="91"/>   t[0 -: pad] := ""
<a name="92"/>   return t
<a name="93"/>end
</pre></body></html>
