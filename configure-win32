#!/bin/sh
clver=$(cl 2>&1|head -1)
case "$clver" in
    *x64*)
        ptrbytes=8
        ;;
    *x86*)
        ptrbytes=4
        ;;
    *)
        echo "Unrecognised cl version: " $clver
        exit 1
        ;;
esac
echo copying config files
cp config/files/Makefile-win32 ./Makefile
cp config/files/lib/iyacc/Makefile-win32 lib/iyacc/Makefile
cp config/files/lib/Makefile-win32 lib/Makefile
cp config/files/lib/xml/Makefile-win32 lib/xml/Makefile
cp config/files/lib/ipl/Makefile-win32 lib/ipl/Makefile
cp config/files/lib/gui/Makefile-win32 lib/gui/Makefile
cp config/files/lib/main/Makefile-win32 lib/main/Makefile
cp config/files/lib/incl/Makefile-win32 lib/incl/Makefile
cp config/files/lib/parser/Makefile-win32 lib/parser/Makefile
cp config/files/base/oix/Makefile-win32 base/oix/Makefile
cp config/files/base/Makefile-win32 base/Makefile
cp config/files/base/rtt/Makefile-win32 base/rtt/Makefile
cp config/files/base/oit/Makefile-win32 base/oit/Makefile
cp config/files/base/common/Makefile-win32 base/common/Makefile
cp config/files/apps/ivib/Makefile-win32 apps/ivib/Makefile
cp config/files/apps/ivib/plugins/Makefile-win32 apps/ivib/plugins/Makefile
cp config/files/apps/Makefile-win32 apps/Makefile
cp config/files/apps/oidoc/Makefile-win32 apps/oidoc/Makefile
cp config/files/examples/Makefile-win32 examples/Makefile
mkdir -p bin
echo creating Makedefs
x=$(pwd)
# The cwd in windows format, eg c:\home\rpp
w=$(cygpath -w "$x")
# Transform \s into \\s, eg c:\\home\\rpp
v=$(echo $w | sed -e "s/\\\/\\\\\\\\/g")
sed -e "s:@CONFIG_DIR@:$x:"  \
    -e "s/@WCONFIG_DIR@/$v/" \
   <./config/files/Makedefs-win32 >Makedefs
echo creating paths.bat
cat >paths.bat <<EOF
# Object Icon path settings
set OIHOME=$w
set OIBIN=%OIHOME%\bin
set OILIB=%OIHOME%\lib
set OIPATH=%OILIB%\main;%OILIB%\gui;%OILIB%\xml;%OILIB%\parser;%OILIB%\ipl
set OIINCL=%OILIB%\incl
set PATH=%PATH%;%OIBIN%
EOF
echo creating paths.sh
cat >paths.sh <<EOF
# Object Icon path settings
export OIHOME="$v"
export OIBIN="\$OIHOME\\\\bin"
export OILIB="\$OIHOME\\\\lib"
export OIPATH="\$OILIB\\\\main;\$OILIB\\\\gui;\$OILIB\\\\xml;\$OILIB\\\\parser;\$OILIB\\\\ipl"
export OIINCL="\$OILIB\\\\incl"
PATH="\$PATH:$x/bin"
export TRACE
EOF
echo creating base/h/version.h
d=$(date -R)
v=$(svnversion)-win32
sed -e "s/@CONFIG_DATE@/$d/"  \
    -e "s/@PACKAGE_VERSION@/$v/" \
    <./config/files/base/h/version.h >base/h/version.h
echo creating base/h/auto.h
cat >base/h/auto.h <<EOF
/* base/h/auto.h.  Generated by configure-win32 */
#define HAVE_TIMEZONE 1
#define HAVE_TZNAME 1
#define HAVE_STRUCT_TM_TM_ISDST 1
#define HAVE_ALLOCA 1
/* sizes of various fundamental types */
#define SIZEOF_SHORT 2
#define SIZEOF_INT 4
#define SIZEOF_LONG 4
#define SIZEOF_VOIDP $ptrbytes
#define SIZEOF_DOUBLE 8
#define SIZEOF_LONG_LONG 8
#define DOUBLE_HAS_WORD_ALIGNMENT 1
EOF
echo creating test/custom.sh
cat >test/custom.sh <<EOF
cmp()
{
        tr -d '\r' <\$1 >junk
	mv junk \$1
	/usr/bin/cmp \$1 \$2
}
EOF
if test -f base/h/define.h ; then
   echo base/h/define.h already exists and is left untouched
else
   echo creating base/h/define.h
   cat >base/h/define.h <<EOF
/* base/h/define.h.  Generated by configure-win32  */
#define MSWIN32 1
EOF
fi
