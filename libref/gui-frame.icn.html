<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>frame.icn</title></head><body><pre>
<a name="1"/>package gui
<a name="2"/>
<a name="3"/>import util
<a name="4"/>
<a name="5"/>class Frame(Component, HasClose)
<a name="6"/>   public
<a name="7"/>      held_flag,
<a name="8"/>      bar,
<a name="9"/>      content,
<a name="10"/>      drag_x_offset,
<a name="11"/>      drag_y_offset
<a name="12"/>
<a name="13"/>   public static const
<a name="14"/>      RSW
<a name="15"/>
<a name="16"/>   private static init()
<a name="17"/>      RSW := env_scale("OI_FRAME_RSW") | scale(12)
<a name="18"/>   end
<a name="19"/>
<a name="20"/>   public override can_drag(e)
<a name="21"/>      return bar.can_drag(e)
<a name="22"/>   end
<a name="23"/>
<a name="24"/>   public setup()
<a name="25"/>      self.bar := create_bar()
<a name="26"/>      self.add(bar)
<a name="27"/>   end
<a name="28"/>
<a name="29"/>   public create_bar()
<a name="30"/>      return FrameBar()
<a name="31"/>   end
<a name="32"/>
<a name="33"/>   public set_title(s)
<a name="34"/>      bar.set_title(s)
<a name="35"/>      link
<a name="36"/>   end
<a name="37"/>
<a name="38"/>   public in_resize_corner(e)
<a name="39"/>      succeed in_region(e) &amp; 
<a name="40"/>         (((self.x + self.w - RSW &lt;= e.x &lt; self.x + self.w) &amp; 
<a name="41"/>          (self.y + self.h - border.get_b_inset() &lt;= e.y &lt; self.y + self.h)) | 
<a name="42"/>          ((self.x + self.w - border.get_r_inset() &lt;= e.x &lt; self.x + self.w) &amp; 
<a name="43"/>           (self.y + self.h - RSW &lt;= e.y &lt; self.y + self.h)))
<a name="44"/>   end
<a name="45"/>
<a name="46"/>   public override display()
<a name="47"/>      border.draw_rect(self.cbwin, self)
<a name="48"/>      self.display_children()
<a name="49"/>   end
<a name="50"/>
<a name="51"/>   public set_content(c)
<a name="52"/>      remove(\self.content)
<a name="53"/>      self.content := c
<a name="54"/>      add(c)
<a name="55"/>      link
<a name="56"/>   end
<a name="57"/>
<a name="58"/>   public override initially()
<a name="59"/>      \self.content | runerr("No content component specified")
<a name="60"/>      Component.initially()
<a name="61"/>   end
<a name="62"/>
<a name="63"/>   public override layout()
<a name="64"/>      bar.x := self.x + border.get_l_inset()
<a name="65"/>      bar.y := self.y + border.get_t_inset()
<a name="66"/>      bar.w := self.w - border.get_total_width()
<a name="67"/>      bar.h := bar.get_preferred_height(bar.w)
<a name="68"/>      content.x := bar.x
<a name="69"/>      content.y := bar.y + bar.h
<a name="70"/>      content.w := bar.w
<a name="71"/>      content.h := self.h - border.get_total_height() - bar.h
<a name="72"/>      every (!children).layout()
<a name="73"/>   end
<a name="74"/>
<a name="75"/>   public override get_default_width()
<a name="76"/>      return border.get_total_width() + max(bar.get_preferred_width(), content.get_preferred_width())
<a name="77"/>   end
<a name="78"/>
<a name="79"/>   public override get_default_height(dw)
<a name="80"/>      dw -:= border.get_total_width()
<a name="81"/>      return border.get_total_height() + bar.get_preferred_height(dw) + content.get_preferred_height(dw)
<a name="82"/>   end
<a name="83"/>
<a name="84"/>   public override get_pointer(e)
<a name="85"/>      if in_resize_corner(e) then
<a name="86"/>         return "bottom right corner"
<a name="87"/>   end
<a name="88"/>
<a name="89"/>   public handle_lpress(e)
<a name="90"/>      if in_region(e) then
<a name="91"/>         to_top()
<a name="92"/>      if can_drag(e) then {
<a name="93"/>         self.held_flag := 1
<a name="94"/>         self.drag_x_offset := e.x - self.x
<a name="95"/>         self.drag_y_offset := e.y - self.y
<a name="96"/>      } else if in_resize_corner(e) then {
<a name="97"/>         self.held_flag := 2
<a name="98"/>         self.drag_x_offset := e.x - (self.x + self.w)
<a name="99"/>         self.drag_y_offset := e.y - (self.y + self.h)
<a name="100"/>      }
<a name="101"/>   end
<a name="102"/>
<a name="103"/>   public handle_ldrag(e)
<a name="104"/>      \self.held_flag | fail
<a name="105"/>      self.invalidate()
<a name="106"/>      case self.held_flag of {
<a name="107"/>         1: {
<a name="108"/>            shift(e.x - drag_x_offset - self.x,
<a name="109"/>                  e.y - drag_y_offset - self.y)
<a name="110"/>            self.x_spec := self.x - parent.x
<a name="111"/>            self.y_spec := self.y - parent.y
<a name="112"/>         }
<a name="113"/>         2: {
<a name="114"/>            self.w_spec := e.x - drag_x_offset - self.x
<a name="115"/>            self.h_spec := e.y - drag_y_offset - self.y
<a name="116"/>            self.resize()
<a name="117"/>         }
<a name="118"/>      }
<a name="119"/>      self.invalidate()
<a name="120"/>   end
<a name="121"/>
<a name="122"/>   public to_top()
<a name="123"/>      if self ~=== parent.z_children[-1] then {
<a name="124"/>         self.set_z(parent.get_top_z())
<a name="125"/>         parent.compute_z_order()
<a name="126"/>         self.invalidate()
<a name="127"/>      }
<a name="128"/>   end
<a name="129"/>
<a name="130"/>   public to_bottom()
<a name="131"/>      if self ~=== parent.z_children[1] then {
<a name="132"/>         self.set_z(parent.get_bottom_z())
<a name="133"/>         parent.compute_z_order()
<a name="134"/>         self.invalidate()
<a name="135"/>      }
<a name="136"/>   end
<a name="137"/>
<a name="138"/>   public override close()
<a name="139"/>      self.invalidate()
<a name="140"/>      self.parent.remove(self)
<a name="141"/>      link
<a name="142"/>   end
<a name="143"/>
<a name="144"/>   public handle_lrelease(e)
<a name="145"/>      self.held_flag := &amp;null
<a name="146"/>   end
<a name="147"/>
<a name="148"/>   public override new()
<a name="149"/>      Component.new()
<a name="150"/>      set_border(RaisedBorder())
<a name="151"/>      setup()
<a name="152"/>      connect(self.handle_lpress, Event.MOUSE_LEFT_PRESS)
<a name="153"/>      connect(self.handle_ldrag, Event.MOUSE_LEFT_DRAG)
<a name="154"/>      connect(self.handle_lrelease, Event.MOUSE_LEFT_RELEASE)
<a name="155"/>      return
<a name="156"/>   end
<a name="157"/>end
<a name="158"/>
<a name="159"/>
<a name="160"/>class FrameBar(Component)
<a name="161"/>   public lab
<a name="162"/>
<a name="163"/>   private static init()
<a name="164"/>      local sz
<a name="165"/>      sz := scale(16)
<a name="166"/>      ImageCache.copy_key_with_resize("gui.WINDOW_CLOSE", "gui.WINDOW_CLOSE_16", sz, sz)
<a name="167"/>   end
<a name="168"/>
<a name="169"/>   public on_close()
<a name="170"/>      self.parent.close()
<a name="171"/>   end
<a name="172"/>
<a name="173"/>   public set_title(s)
<a name="174"/>      lab.set_label(s)
<a name="175"/>      link
<a name="176"/>   end
<a name="177"/>
<a name="178"/>   public override can_drag(e)
<a name="179"/>      return lab.in_region(e)
<a name="180"/>   end
<a name="181"/>
<a name="182"/>   public setup()
<a name="183"/>      local b
<a name="184"/>      set_layout(GridLayout().set_doi(0).set_dii(0))
<a name="185"/>      lab := Label().
<a name="186"/>         set_constraint("x_weight", 1).
<a name="187"/>         set_constraint("x_fill", &amp;yes).
<a name="188"/>         set_constraint("l_inset", scale(3)).
<a name="189"/>         set_label("Frame")
<a name="190"/>      add(lab)
<a name="191"/>      b := IconButton().
<a name="192"/>         set_accepts_focus(&amp;no).
<a name="193"/>         set_constraint("r_inset", scale(3)).
<a name="194"/>         set_tooltip("Close")
<a name="195"/>      b.set_border(NullBorder())
<a name="196"/>      b.set_paint(ImagePaint().set_cache("gui.WINDOW_CLOSE"))
<a name="197"/>      b.connect(self.on_close, Event.ACTION)
<a name="198"/>      self.add(b)
<a name="199"/>   end
<a name="200"/>
<a name="201"/>   public override new()
<a name="202"/>      Component.new()
<a name="203"/>      setup()
<a name="204"/>      return
<a name="205"/>   end
<a name="206"/>end
</pre></body></html>
