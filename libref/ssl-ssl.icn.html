<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>ssl.icn</title></head><body><pre>
<a name="1"/>package ssl
<a name="2"/>
<a name="3"/>import io, lang, util
<a name="4"/>
<a name="5"/>#
<a name="6"/># Succeed if the ssl library is available, or fail and set `&amp;why` if
<a name="7"/># it isn't.
<a name="8"/>#
<a name="9"/>procedure ssl_available()
<a name="10"/>   succeed \SslStream.LOADED | error(SslStream.WHY)
<a name="11"/>end
<a name="12"/>
<a name="13"/>#
<a name="14"/># Extract the SSL_get_error value from `&amp;why`, or fail if not found.
<a name="15"/>#
<a name="16"/>procedure ssl_error()
<a name="17"/>   return errno("SSL_get_error")
<a name="18"/>end
<a name="19"/>
<a name="20"/>#
<a name="21"/># A very simple SSL stream, using the openssl library.
<a name="22"/>#
<a name="23"/>final class SslStream(Stream, HasCloseUnderlying, NoCopy)
<a name="24"/>   private
<a name="25"/>      ptr
<a name="26"/>   private const
<a name="27"/>      other
<a name="28"/>
<a name="29"/>   public static const
<a name="30"/>      ERROR_NONE,
<a name="31"/>      ERROR_SSL,
<a name="32"/>      ERROR_WANT_READ,
<a name="33"/>      ERROR_WANT_WRITE,
<a name="34"/>      ERROR_SYSCALL,
<a name="35"/>      ERROR_ZERO_RETURN,
<a name="36"/>      LOADED,
<a name="37"/>      WHY
<a name="38"/>
<a name="39"/>   private static init()
<a name="40"/>      local t
<a name="41"/>
<a name="42"/>      ERROR_NONE                 := 0
<a name="43"/>      ERROR_SSL                  := 1
<a name="44"/>      ERROR_WANT_READ            := 2
<a name="45"/>      ERROR_WANT_WRITE           := 3
<a name="46"/>      ERROR_SYSCALL              := 5
<a name="47"/>      ERROR_ZERO_RETURN          := 6
<a name="48"/>
<a name="49"/>      if t := Files.find_native_lib("objecticonssllib") then {
<a name="50"/>         if Class.load_library(t) then
<a name="51"/>            LOADED := t
<a name="52"/>         else
<a name="53"/>            WHY := "Failed to load ssl library: " || &amp;why
<a name="54"/>      } else
<a name="55"/>         WHY := "Ssl library not found on OI_NATIVE path"
<a name="56"/>   end
<a name="57"/>
<a name="58"/>   public native connect()
<a name="59"/>
<a name="60"/>   public native verify()
<a name="61"/>
<a name="62"/>   #
<a name="63"/>   # Perform a shutdown on the connection; `full` is a flag; if set then
<a name="64"/>   # the shutdown will wait for a reply to the "close notify" from the
<a name="65"/>   # server.
<a name="66"/>   #
<a name="67"/>   public native shutdown(full)
<a name="68"/>
<a name="69"/>   public override native in(n)
<a name="70"/>
<a name="71"/>   public override native out(s)
<a name="72"/>
<a name="73"/>   #
<a name="74"/>   # Close this connection, and if the close underlying flag has been
<a name="75"/>   # set, the underlying connection.  Note that `shutdown()` is not
<a name="76"/>   # called on the connection.
<a name="77"/>   #
<a name="78"/>   public override close()
<a name="79"/>      local f
<a name="80"/>      close_impl() | (f := &amp;why)
<a name="81"/>      if \close_underlying_flag then
<a name="82"/>         other.close() | (/f := &amp;why)
<a name="83"/>      link error_if(f)
<a name="84"/>   end
<a name="85"/>
<a name="86"/>   private native close_impl()
<a name="87"/>
<a name="88"/>   public override get_mode()
<a name="89"/>      return other.get_mode()
<a name="90"/>   end
<a name="91"/>
<a name="92"/>   private static native new_impl(other, host)
<a name="93"/>
<a name="94"/>   #
<a name="95"/>   # Create a new SslStream.
<a name="96"/>   #
<a name="97"/>   # :Parameters :
<a name="98"/>   # :  `other` - an already connected `SocketStream` over which the connection
<a name="99"/>   #              will operate
<a name="100"/>   # :Parameters :
<a name="101"/>   # :  `host` - the name of the host corresponding to the connection
<a name="102"/>   public new(other, host)
<a name="103"/>      ssl_available() | fail
<a name="104"/>      ptr := new_impl(other, host) | fail
<a name="105"/>      self.other := other
<a name="106"/>      return
<a name="107"/>   end
<a name="108"/>end
</pre></body></html>
