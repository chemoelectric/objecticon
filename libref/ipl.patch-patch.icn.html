<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>patch.icn</title></head><body><pre>
<a name="1"/>############################################################################
<a name="2"/>#
<a name="3"/>#	File:     patch.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures for UNIX-like patch(1)
<a name="6"/>#
<a name="7"/>#	Author:   Rich Morin
<a name="8"/>#
<a name="9"/>#	Date:     June 18, 1990
<a name="10"/>#
<a name="11"/>############################################################################
<a name="12"/>#
<a name="13"/>#   This file is in the public domain.
<a name="14"/>#
<a name="15"/>############################################################################
<a name="16"/>#
<a name="17"/>#  This procedure produces a sequence of edited items, reading a source
<a name="18"/>#  stream (from) and a stream of difference records (diffs), as generated
<a name="19"/>#  by dif.icn.
<a name="20"/>#
<a name="21"/>#  An optional parameter (rev) causes the edits to be made in reverse.
<a name="22"/>#  This allows an old stream to be regenerated from a new stream and an
<a name="23"/>#  appropriate stream of difference records.
<a name="24"/>#
<a name="25"/>#  The original patch(1) utility was written by Larry Wall, and is used
<a name="26"/>#  widely in the UNIX community.  See also diffu.icn and patchu.icn, the
<a name="27"/>#  utility program versions of dif.icn and patch.icn.
<a name="28"/>#
<a name="29"/>#  Usage:	patch(old, diff)	# patch old to new via diff
<a name="30"/>#  		patch(new, diff, rev)	# patch new to old via diff
<a name="31"/>#
<a name="32"/>############################################################################
<a name="33"/>#
<a name="34"/>#  Requires: co-expressions
<a name="35"/>#
<a name="36"/>############################################################################
<a name="37"/>
<a name="38"/>package ipl.patch
<a name="39"/>
<a name="40"/>import
<a name="41"/>   io(ewrite)
<a name="42"/>
<a name="43"/>procedure patch(from, diff, rev)
<a name="44"/>  local c_diff, c_from, cnte, cnti, i, item, ldr, o
<a name="45"/>
<a name="46"/>  initial {
<a name="47"/>    i := 1
<a name="48"/>    o := 2
<a name="49"/>    if \rev then
<a name="50"/>      i :=: o
<a name="51"/>      
<a name="52"/>    c_diff := create !diff
<a name="53"/>    c_from := create !from
<a name="54"/>
<a name="55"/>    cnti := item := 0
<a name="56"/>    ldr  := @c_diff
<a name="57"/>    cnte := ldr[i].pos
<a name="58"/>  }
<a name="59"/>
<a name="60"/>  repeat {
<a name="61"/>
<a name="62"/>    while /ldr | cnti &lt; cnte-1 do {		# copy old items
<a name="63"/>      cnti +:= 1
<a name="64"/>      if item := @c_from then
<a name="65"/>        suspend item
<a name="66"/>      else {
<a name="67"/>        item := &amp;null
<a name="68"/>        break
<a name="69"/>      }
<a name="70"/>    }
<a name="71"/>
<a name="72"/>    if \ldr then {				# still have edits
<a name="73"/>      every 1 to *ldr[i].diffs do {		# discard items
<a name="74"/>        cnti +:= 1
<a name="75"/>        @c_from | zot_patch("unexpected end of stream")
<a name="76"/>      }
<a name="77"/>
<a name="78"/>      if *ldr[o].diffs &gt; 0 then			# copy new items
<a name="79"/>        suspend !ldr[o].diffs
<a name="80"/>
<a name="81"/>      if ldr := @c_diff then			# get next edit
<a name="82"/>        cnte := ldr[i].pos
<a name="83"/>      else
<a name="84"/>        ldr := &amp;null
<a name="85"/>    }
<a name="86"/>
<a name="87"/>    if /item &amp; /ldr then
<a name="88"/>      fail
<a name="89"/>  }
<a name="90"/>
<a name="91"/>end
<a name="92"/>
<a name="93"/>
<a name="94"/># exit w/ message
<a name="95"/>procedure zot_patch(msg)			
<a name="96"/>  ewrite("patch: ", msg)
<a name="97"/>  exit(1)
<a name="98"/>end
</pre></body></html>
