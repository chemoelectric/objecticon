<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta charset="UTF-8"><title>cgi.icn</title></head><body><pre>
<a name="1"/>############################################################################ 
<a name="2"/>#
<a name="3"/>#	File:     cgi.icn
<a name="4"/>#
<a name="5"/>#	Subject:  Procedures for writing CGI scripts
<a name="6"/>#
<a name="7"/>#	Authors:  Joe Van Meter, Clinton Jeffery, and Federico Balbi
<a name="8"/>#
<a name="9"/>#	Date:     May 4, 2000
<a name="10"/>#
<a name="11"/>############################################################################ 
<a name="12"/>#
<a name="13"/># This library makes programming cgi programs easier by automatically 
<a name="14"/># checking for title and body procedures.  There are other procedures
<a name="15"/># that do some repetitive things for the programmer.
<a name="16"/>#
<a name="17"/>############################################################################ 
<a name="18"/>
<a name="19"/>package ipl.cgi
<a name="20"/>
<a name="21"/>import
<a name="22"/>   io(open, read, reads, stop,
<a name="23"/>      write, writes, Stream),
<a name="24"/>   posix(System)
<a name="25"/>
<a name="26"/>global cgi			# table of input fields
<a name="27"/>
<a name="28"/>
<a name="29"/>#
<a name="30"/># cgiEcho(file,args[]) - write a file to both HTML stdout and a regular
<a name="31"/>#  text file, if one is present
<a name="32"/>#
<a name="33"/>procedure cgiEcho(f, args[])
<a name="34"/>   push(args, f)
<a name="35"/>   if is(f, Stream) then {	# if we have a file
<a name="36"/>      write ! args		# write to it
<a name="37"/>      pop(args)			# and then discard it
<a name="38"/>      }
<a name="39"/>   put(args, "&lt;br&gt;")		# write HTML
<a name="40"/>   write ! args
<a name="41"/>end
<a name="42"/>
<a name="43"/>
<a name="44"/>#
<a name="45"/># cgiInput(type, name, values) -
<a name="46"/>#
<a name="47"/>procedure cgiInput(ty,nam,va)
<a name="48"/>   every is := !va do {
<a name="49"/>      writes("[&lt;INPUT TYPE=\"",ty,"\" NAME=\"",nam,"\" VALUE=\"",is,"\"")
<a name="50"/>      if is===va[1] then
<a name="51"/>	  writes(" CHECKED")
<a name="52"/>      write("&gt;", is, "]")
<a name="53"/>      }
<a name="54"/>end
<a name="55"/>
<a name="56"/>#
<a name="57"/># cgiSelect(name, values)
<a name="58"/># this program with the name and value makes a select box
<a name="59"/>#
<a name="60"/>procedure cgiSelect(nam, va)
<a name="61"/>   write("&lt;SELECT NAME=\"", nam, "\"&gt;")
<a name="62"/>   every is := !va do {
<a name="63"/>      writes("&lt;OPTION" )
<a name="64"/>      if is==va[1] then writes(" SELECTED")
<a name="65"/>      write("&gt;", is)
<a name="66"/>      }
<a name="67"/>   write("&lt;/SELECT&gt;")
<a name="68"/>end
<a name="69"/>
<a name="70"/>#
<a name="71"/># cgiXYCoord()
<a name="72"/># This procedure is used with a ISMAP to figure out what the x and y coords
<a name="73"/># and if they are between a certain boundry. It returns the value of the 
<a name="74"/># list that was entered.
<a name="75"/># 
<a name="76"/>record HMap(value,x1,y1,x2,y2)
<a name="77"/>
<a name="78"/>procedure cgiXYCoord(hlst)
<a name="79"/>   local title,x,y,q
<a name="80"/>   title := hlst[1]
<a name="81"/>   System.getenv("QUERY_STRING") ? {
<a name="82"/>      x := tab(find(","))
<a name="83"/>      move(1)
<a name="84"/>      y := tab(0)
<a name="85"/>      }
<a name="86"/>   every q := 2 to *hlst do {
<a name="87"/>      if (hlst[q].x1 &lt; x &lt; hlst[q].x2) &amp; (hlst[q].y1 &lt; y &lt; hlst[q].y2) then {
<a name="88"/>	 title := hlst[q].value
<a name="89"/>         }
<a name="90"/>      }
<a name="91"/>   return title
<a name="92"/>end
<a name="93"/>
<a name="94"/>procedure cgiMyURL()
<a name="95"/>   return "http://" || System.getenv("SERVER_NAME") || System.getenv("SCRIPT_NAME")
<a name="96"/>end
<a name="97"/>
<a name="98"/>procedure cgiMethGet()
<a name="99"/>   if System.getenv("REQUEST_METHOD")==="GET" then return
<a name="100"/>   # else fail
<a name="101"/>end
<a name="102"/>
<a name="103"/>#
<a name="104"/># cgiReadParse()
<a name="105"/># This procedure gets input from either QUERY_STRING or stdin puts the 
<a name="106"/># values with their variable names and returns a table with references
<a name="107"/># from the variables to their values
<a name="108"/>#
<a name="109"/>
<a name="110"/>procedure cgiReadParse()
<a name="111"/>   local html,it,line,ct,cl,boundary,content,s,delim,nam,filename,value,r,k,data,c1,c2
<a name="112"/>static hexen
<a name="113"/>initial {
<a name="114"/>   hexen := &amp;digits ++ 'ABCDEF'
<a name="115"/>   }
<a name="116"/>   html := [ ]
<a name="117"/>   it := ""
<a name="118"/>   cgi := table(0)
<a name="119"/>   line := ""
<a name="120"/>
<a name="121"/>   ct := System.getenv("CONTENT_TYPE")
<a name="122"/>   cl := System.getenv("CONTENT_LENGTH")
<a name="123"/>   if match("multipart/form-data;", ct) then {
<a name="124"/>      ct ? {
<a name="125"/>	 tab(find("boundary=") + 9)
<a name="126"/>	 boundary := "--" || tab(0)
<a name="127"/>         }
<a name="128"/>   content := reads(, cl)
<a name="129"/>   content ? {
<a name="130"/>      while tab(find(boundary)) do {
<a name="131"/>	  tab(find("\n")+1)
<a name="132"/>	  while match("Content-") do {
<a name="133"/>	      line := tab(find("\n"))
<a name="134"/>	      move(1)
<a name="135"/>	      line ? {
<a name="136"/>		  s := tab(many(&amp;letters++'\-')) | stop("bogons")
<a name="137"/>		  case s of {
<a name="138"/>		  "Content-Disposition": {
<a name="139"/>		      move (2)
<a name="140"/>		      if ="form-data; " then {
<a name="141"/>			  if ="name=" then {
<a name="142"/>			      if delim := ="\"" then {
<a name="143"/>				 nam := tab(find("\""))
<a name="144"/>				 ="\""
<a name="145"/>				 if nam == "file" then {
<a name="146"/>				    ="; "
<a name="147"/>				    if ="filename=" then {
<a name="148"/>				       if delim := ="\"" then {
<a name="149"/>					  filename := tab(find("\""))
<a name="150"/>					  cgi["filename"] := filename
<a name="151"/>					  }
<a name="152"/>				       }
<a name="153"/>				    }
<a name="154"/>			         }
<a name="155"/>			      }
<a name="156"/>		           }
<a name="157"/>		  }
<a name="158"/>		  "Content-Type": {
<a name="159"/>			}
<a name="160"/>		  default: cgiEcho("eh? ", line)
<a name="161"/>	      }
<a name="162"/>	      }
<a name="163"/>	  }
<a name="164"/>	  #if it didn't match "Content-" its not header any more, skip a line
<a name="165"/>	  tab(find("\n")+1)
<a name="166"/>	  # then grab rest
<a name="167"/>	  value := tab(find(boundary)) | stop("incomplete value")
<a name="168"/>	  if value[-1] == "\n" then value[-1] := ""
<a name="169"/>	  if value[-1] == "\r" then value[-1] := ""
<a name="170"/>	  if \nam then cgi[\nam] := value
<a name="171"/>	  if match(boundary || "--") then {
<a name="172"/>	      break
<a name="173"/>	      }
<a name="174"/>	  else if match(boundary) then { # no terminating --
<a name="175"/>	      next
<a name="176"/>	      }
<a name="177"/>      }
<a name="178"/>  }
<a name="179"/>  }
<a name="180"/>else {
<a name="181"/>   if cgiMethGet() then
<a name="182"/>      line := System.getenv("QUERY_STRING")
<a name="183"/>   else line := reads(, System.getenv("CONTENT_LENGTH"))
<a name="184"/>   line ? {
<a name="185"/>      while put(html, tab(find("&amp;"))) do {
<a name="186"/>	 tab(many('&amp;'))
<a name="187"/>         }
<a name="188"/>      put(html, tab(0))
<a name="189"/>      }
<a name="190"/>   every r := 1 to *html do
<a name="191"/>      html[r] := map(html[r], "+", " ")
<a name="192"/>   every !html ? {
<a name="193"/>      # does this really loop multiple times?  If so, what are we
<a name="194"/>      # throwing away?
<a name="195"/>      while k := tab(find("=")) do
<a name="196"/>         tab(many('='))
<a name="197"/>      data := tab(0)
<a name="198"/>
<a name="199"/>      while data ?:= ((tab(find("%")) ||
<a name="200"/>		      (move(1) &amp;
<a name="201"/>		      (c1 := tab(any(hexen))) &amp; (c2 := tab(any(hexen))) &amp;
<a name="202"/>		      cgiHexchar(c1,c2)) ||
<a name="203"/>		       tab(0)))
<a name="204"/>
<a name="205"/>      if member(cgi, k) then cgi[k] ||:= "," || data
<a name="206"/>      else cgi[k] := data
<a name="207"/>      }
<a name="208"/>}
<a name="209"/>   return cgi
<a name="210"/>end
<a name="211"/>
<a name="212"/>#
<a name="213"/># procedure cgiPrintVariables
<a name="214"/># prints the variables with their value
<a name="215"/>#
<a name="216"/>
<a name="217"/>procedure cgiPrintVariables(in)
<a name="218"/>   local X
<a name="219"/>   write("&lt;br&gt;")
<a name="220"/>   every X := key(in) do
<a name="221"/>      write("&lt;b&gt;",X,"&lt;/b&gt; is &lt;i&gt;",in[X],"&lt;/i&gt;&lt;p&gt;")
<a name="222"/>end
<a name="223"/>
<a name="224"/>procedure cgiError(in)
<a name="225"/>   local i
<a name="226"/>   if /in then
<a name="227"/>      write("Error: Script ", cgiMyURL(), " encountered fatal error")
<a name="228"/>   else { 
<a name="229"/>      write("Content-type: text/html\n\n")
<a name="230"/>      write("&lt;html&gt;&lt;head&gt;&lt;title&gt;",in[1],"&lt;/title&gt;&lt;/head&gt;\n")
<a name="231"/>      every i := 2 to *in do
<a name="232"/>	 write("&lt;p&gt;", in[i], "&lt;/p&gt;")
<a name="233"/>      write("&lt;/body&gt;&lt;/html&gt;\n")
<a name="234"/>      }
<a name="235"/>
<a name="236"/>end
<a name="237"/>
<a name="238"/>procedure cgiHexval(c)
<a name="239"/>    if any(&amp;digits, c) then return integer(c)
<a name="240"/>    if any('ABCDEF', c) then return ord(c) - ord("A") + 10
<a name="241"/>end
<a name="242"/>
<a name="243"/>procedure cgiHexchar(c1,c2)
<a name="244"/>    return char(cgiHexval(c1) * 16 + cgiHexval(c2))
<a name="245"/>end
<a name="246"/>
<a name="247"/>#
<a name="248"/># procedure cgiColorToHex
<a name="249"/># if a basic color is entered into the procedure the hex values
<a name="250"/># is returned
<a name="251"/>#
<a name="252"/>
<a name="253"/>procedure cgiColorToHex(s)
<a name="254"/>static ColorTbl
<a name="255"/>initial {
<a name="256"/>   ColorTbl:=table(0)
<a name="257"/>   ColorTbl["black"] := "000000"
<a name="258"/>   ColorTbl["gray"]  := "666666"
<a name="259"/>   ColorTbl["white"] := "ffffff"
<a name="260"/>   ColorTbl["pink"]  := "ff0099"
<a name="261"/>   ColorTbl["violet"]:= "ffccff"
<a name="262"/>   ColorTbl["brown"] := "996633"
<a name="263"/>   ColorTbl["red"]   := "ff0000"
<a name="264"/>   ColorTbl["orange"]:= "ff9900"
<a name="265"/>   ColorTbl["yellow"]:= "ffff33"
<a name="266"/>   ColorTbl["green"] := "339933"
<a name="267"/>   ColorTbl["cyan"]  := "ff66cc"
<a name="268"/>   ColorTbl["blue"]  := "0000ff"
<a name="269"/>   ColorTbl["purple"]:= "990099"
<a name="270"/>   ColorTbl["magenta"]:="cc0066"
<a name="271"/>   }
<a name="272"/>
<a name="273"/>#   if rv := ColorValue(s) then {
<a name="274"/>#      # unfinished; convert 16-bit decimal values into 8-bits/component hex
<a name="275"/>#      }
<a name="276"/>   return ColorTbl[s]
<a name="277"/>end	
<a name="278"/>
<a name="279"/>#
<a name="280"/># Procedure cgiPrePro
<a name="281"/># This procedure goes through a file writes out 
<a name="282"/># either anything between ALL and the value that are passed into the 
<a name="283"/># procedure.
<a name="284"/>#
<a name="285"/>
<a name="286"/>procedure cgiPrePro(filename,def)
<a name="287"/>   local AllFlag,DefFlag,all,look,intext,here
<a name="288"/>   AllFlag := 0
<a name="289"/>   DefFlag := 0
<a name="290"/>   all := "&lt;!-- ALL"
<a name="291"/>   look := "&lt;!-- "||def	
<a name="292"/>   intext := open(filename)
<a name="293"/>   while here:=read(intext) do {
<a name="294"/>      if match(all,here) then { 
<a name="295"/>	 if AllFlag = 1 then
<a name="296"/>	     AllFlag := 0
<a name="297"/>	 else {
<a name="298"/>	    here := read(intext)
<a name="299"/>	    AllFlag := 1
<a name="300"/>	    }
<a name="301"/>         }
<a name="302"/>      if match(look,here) then
<a name="303"/>	 if DefFlag = 1 then {
<a name="304"/>	    DefFlag := 0
<a name="305"/>	    }
<a name="306"/>	 else {
<a name="307"/>	    DefFlag := 1
<a name="308"/>	    here := read(intext)
<a name="309"/>	    }
<a name="310"/>      if AllFlag = 1 then writes(here)
<a name="311"/>      else if DefFlag = 1 then writes(here)
<a name="312"/>      }
<a name="313"/>end
<a name="314"/>
<a name="315"/>#
<a name="316"/># cgiRemoteUser(): returns the reported Web user.
<a name="317"/>#
<a name="318"/>procedure cgiRemoteUser()
<a name="319"/>   return System.getenv("REMOTE_USER")
<a name="320"/>end
<a name="321"/>
<a name="322"/>#
<a name="323"/># Procedure cgiRndImg
<a name="324"/>#
<a name="325"/># if a list is passed into the procedure then an img is randomized
<a name="326"/>#
<a name="327"/>
<a name="328"/>procedure cgiRndImg(GifList, AltText)
<a name="329"/>   writes("&lt;img src=\"",?GifList,"\"", " alt=\"",AltText,"\"", "&gt;")
<a name="330"/>end
<a name="331"/>
<a name="332"/>#
<a name="333"/># procedure main
<a name="334"/>#
<a name="335"/># This procedure checks for a title procedure and a body procedure and places 
<a name="336"/># the html headers and tail... it then calls the users cgimain.
<a name="337"/>#
<a name="338"/>global cgititle, cgiBBuilder, cgimain
<a name="339"/>procedure main(args)
<a name="340"/>   local BB
<a name="341"/>   write("Content-type: text/html\n\n")
<a name="342"/>   write("&lt;html&gt;")
<a name="343"/>   if \cgititle then {
<a name="344"/>      write("&lt;title&gt;")
<a name="345"/>      write(cgititle(args))
<a name="346"/>      write("&lt;/title&gt;")
<a name="347"/>      }
<a name="348"/>   writes("&lt;body")
<a name="349"/>   if \cgiBBuilder then {
<a name="350"/>      BB := cgiBBuilder(args)
<a name="351"/>      writes(" background=\"",BB["background"],"\"")	
<a name="352"/>      writes(" bgcolor=\"",BB["bgcolor"],"\"")	
<a name="353"/>      writes(" text=\"",BB["text"],"\"")	
<a name="354"/>      writes(" link=\"",BB["link"],"\"")	
<a name="355"/>      writes(" vlink=\"",BB["vlink"],"\"")	
<a name="356"/>      writes(" bgproperties=\"",BB["bgproperties"],"\"")	
<a name="357"/>      }
<a name="358"/>   write("&gt;")
<a name="359"/>   cgiReadParse()
<a name="360"/>   cgimain(args)
<a name="361"/>   write("&lt;/body&gt;")
<a name="362"/>   write("&lt;/html&gt;")
<a name="363"/>end
<a name="364"/>
<a name="365"/>
</pre></body></html>
